<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‡¼í•‘ê²€ìƒ‰ í†µí•© ëŒ€ì‹œë³´ë“œ V3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root { --naver-green: #00c73c; --border: #ddd; --up: #ff4d4d; --down: #3182ce; }
        body { font-family: 'Malgun Gothic', sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 100%; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        
        #uploadSection { display: flex; gap: 20px; padding: 20px; background: #eee; border-radius: 8px; align-items: flex-end; margin-bottom: 20px; }
        .file-input-group { display: flex; flex-direction: column; font-size: 12px; font-weight: bold; gap: 5px; }
        
        .filter-section { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .card { min-width: 120px; padding: 10px 15px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; font-size: 13px; }
        .card.active { border: 2px solid var(--naver-green); background: #f0fff4; font-weight: bold; }
        .card:hover { background: #f9f9f9; }
        .reset-btn { padding: 8px 18px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; flex-shrink: 0; }
        .reset-btn:hover { background: #c0392b; }

        .table-wrapper { overflow-x: auto; max-height: 500px; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        th { background: #f1f3f4; padding: 12px; font-size: 12px; cursor: pointer; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ddd; white-space: nowrap; }
        td { border-bottom: 1px solid #eee; padding: 10px; text-align: center; font-size: 13px; line-height: 1.4; white-space: nowrap; }
        .col-campaign, .col-adgroup { max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-product { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
        
        .diff { font-size: 10px; color: #888; }
        .up { color: var(--up); } .down { color: var(--down); }

        #detailSection { margin-top: 30px; padding: 25px; border: 1px solid var(--border); border-radius: 12px; display: none; background: #fff; }
        .tab-area { display: flex; gap: 8px; margin-top: 25px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 8px 16px; border: 1px solid var(--border); border-radius: 20px; background: #fff; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .tab-btn.active { background: var(--naver-green); color: white; border-color: var(--naver-green); }
        .tab-btn:hover { background: #f0f0f0; }
        
        .chart-grid { display: flex; flex-direction: column; gap: 20px; }
        .chart-container { border: 1px solid #f0f0f0; padding: 15px; border-radius: 8px; background: #fafafa; position: relative; }
        .chart-box { height: 350px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 6px; }
        
        /* Stats Styles */
        .stats-row { display: flex; gap: 15px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; justify-content: space-around; }
        .stat-item { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .stat-item:last-child { border-right: none; }
        .stat-label { font-size: 11px; color: #666; margin-bottom: 4px; }
        .stat-value { font-size: 14px; font-weight: bold; color: #2c3e50; }
        .stat-value.max { color: var(--up); }
        .stat-value.min { color: var(--down); }

        canvas { width: 100% !important; height: 100% !important; }

        .img-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .badge-group { background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›ï¸ ì‡¼í•‘ê²€ìƒ‰ í†µí•© ëŒ€ì‹œë³´ë“œ (ìµœê·¼ 7ì¼ vs ì§€ë‚œì£¼)</h2>
    
    <div id="uploadSection">
        <div class="file-input-group"><label>1. ìƒí’ˆ ì •ë³´ (TSV)</label><input type="file" id="tsvFile" accept=".tsv"></div>
        <div class="file-input-group"><label>2. ì„±ê³¼ ë³´ê³ ì„œ (CSV)</label><input type="file" id="csvFile" accept=".csv"></div>
        <button onclick="startAnalysis()" style="background:var(--naver-green); color:white; border:none; padding:10px 25px; border-radius:6px; cursor:pointer; font-weight:bold;">ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button>
    </div>

    <div id="resultArea" style="display:none;">
        <div id="cpCards" class="filter-section"></div>
        <div id="grCards" class="filter-section"></div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ì´ë¯¸ì§€</th>
                        <th onclick="resort('cp')" class="col-campaign">ìº í˜ì¸</th>
                        <th onclick="resort('gr')" class="col-adgroup">ê´‘ê³ ê·¸ë£¹</th>
                        <th class="col-product">ìƒí’ˆëª…</th>
                        <th onclick="resort('cost')">ê´‘ê³ ë¹„</th>
                        <th onclick="resort('view')">ë…¸ì¶œìˆ˜</th>
                        <th onclick="resort('click')">í´ë¦­ìˆ˜</th>
                        <th onclick="resort('ctr')">í´ë¦­ìœ¨</th>
                        <th onclick="resort('cpc')">CPC</th>
                        <th onclick="resort('cv')">ì „í™˜ìˆ˜</th>
                        <th onclick="resort('amt')">ë§¤ì¶œì•¡</th>
                        <th onclick="resort('roas')">ROAS</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="detailSection">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="detailTitle" style="margin:0;"></h3>
                <button onclick="document.getElementById('detailSection').style.display='none'" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold; font-size: 16px;">[âœ• ë‹«ê¸°]</button>
            </div>
            <div class="tab-area" id="tabArea"></div>
            <div class="chart-grid">
                <div class="chart-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h5 style="margin:0;">ğŸ“… ì¼ë³„ ì¶”ì´</h5>
                    </div>
                    <div id="dayStats" class="stats-row"></div>
                    <div class="chart-box"><canvas id="dayChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h5 style="margin:0;">ğŸ“Š ì£¼ë³„ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h5>
                    </div>
                    <div id="weekStats" class="stats-row"></div>
                    <div class="chart-box"><canvas id="weekChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let raw = [], pMap = {}, aggList = [];
    let dChart = null, wChart = null;
    let metric = 'amt';
    let sKey = 'cv', sDir = 'desc', activeMat = null;
    let filterCp = null, filterGr = null;

    const metricNames = { 
        amt:'ë§¤ì¶œì•¡', 
        cost:'ê´‘ê³ ë¹„', 
        view:'ë…¸ì¶œìˆ˜', 
        click:'í´ë¦­ìˆ˜', 
        cv:'ì „í™˜ìˆ˜', 
        ctr:'í´ë¦­ìœ¨(%)', 
        cvr:'ì „í™˜ìœ¨(%)', 
        roas:'ROAS(%)',
        cpc:'CPC'
    };

    function startAnalysis() {
        const tsv = document.getElementById('tsvFile').files[0];
        const csv = document.getElementById('csvFile').files[0];
        if(!tsv || !csv) return alert("íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");

        Papa.parse(tsv, { delimiter: "\t", complete: (t) => {
            t.data.forEach(r => { 
                if(r[2]) pMap[r[2].trim()] = { name: r[14], img: r[15] }; 
            });
            
            Papa.parse(csv, { encoding: "EUC-KR", skipEmptyLines: true, complete: (c) => {
                const headRow = c.data.findIndex(r => r.join(',').includes("ìº í˜ì¸ìœ í˜•"));
                raw = c.data.slice(headRow + 1)
                    .filter(r => r[0] === "ì‡¼í•‘ê²€ìƒ‰")
                    .map(r => ({
                        cp: r[1], 
                        gr: r[2], 
                        mat: r[3].trim(), 
                        date: r[6], 
                        week: r[7],
                        cost: Number(r[8]||0), 
                        view: Number(r[9]||0), 
                        click: Number(r[10]||0), 
                        cv: Number(r[11]||0), 
                        amt: Number(r[12]||0)
                    }));
                
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                
                resetFilters();
            }});
        }});
    }

    function resetFilters() {
        filterCp = null;
        filterGr = null;
        renderFilters();
        refresh();
    }

    function setCP(c) { 
        filterCp = c; 
        filterGr = null; 
        renderFilters(); 
        refresh(); 
    }
    
    function setGR(g) { 
        filterGr = g; 
        renderFilters(); 
        refresh(); 
    }

    function renderFilters() {
        const cps = [...new Set(raw.map(d => d.cp))];
        let h = `<button class="reset-btn" onclick="resetFilters()">ğŸ”„ ì´ˆê¸°í™”</button>`;
        h += `<div class="card ${!filterCp?'active':''}" onclick="setCP(null)">ì „ì²´ ìº í˜ì¸</div>`;
        cps.forEach(c => h += `<div class="card ${filterCp===c?'active':''}" onclick="setCP('${c}')">${c}</div>`);
        document.getElementById('cpCards').innerHTML = h;

        if(filterCp) {
            const grs = [...new Set(raw.filter(d => d.cp === filterCp).map(d => d.gr))];
            let gh = `<div class="card ${!filterGr?'active':''}" onclick="setGR(null)">ì „ì²´ ê´‘ê³ ê·¸ë£¹</div>`;
            grs.forEach(g => gh += `<div class="card ${filterGr===g?'active':''}" onclick="setGR('${g}')">${g}</div>`);
            document.getElementById('grCards').innerHTML = gh;
        } else {
            document.getElementById('grCards').innerHTML = '';
        }
    }

    function refresh() {
        const allDates = [...new Set(raw.map(d=>d.date))].sort().reverse();
        const curDates = allDates.slice(0, 7);
        const preDates = allDates.slice(7, 14);

        let filtered = raw.filter(d => 
            (!filterCp || d.cp === filterCp) &&
            (!filterGr || d.gr === filterGr)
        );

        const agg = {};
        const gCheck = {};
        
        filtered.forEach(r => {
            const pName = pMap[r.mat]?.name || "ì•Œìˆ˜ì—†ìŒ";
            const gk = `${r.cp}_${r.gr}_${pName}`;
            if(!gCheck[gk]) gCheck[gk] = new Set(); 
            gCheck[gk].add(r.mat);
            
            if(!agg[r.mat]) {
                agg[r.mat] = { 
                    cp: r.cp, gr: r.gr, mat: r.mat,
                    cost:0, view:0, click:0, cv:0, amt:0, 
                    pCost:0, pView:0, pClick:0, pCv:0, pAmt:0 
                };
            }
            
            if(curDates.includes(r.date)) { 
                agg[r.mat].cost += r.cost; 
                agg[r.mat].view += r.view; 
                agg[r.mat].click += r.click; 
                agg[r.mat].cv += r.cv; 
                agg[r.mat].amt += r.amt; 
            }
            if(preDates.includes(r.date)) { 
                agg[r.mat].pCost += r.cost; 
                agg[r.mat].pView += r.view; 
                agg[r.mat].pClick += r.click; 
                agg[r.mat].pCv += r.cv; 
                agg[r.mat].pAmt += r.amt; 
            }
        });

        aggList = Object.values(agg).map(r => {
            const pName = pMap[r.mat]?.name || "ë§¤ì¹­ì‹¤íŒ¨";
            return {
                ...r, 
                pName: pName,
                pImg: pMap[r.mat]?.img || "",
                isG: gCheck[`${r.cp}_${r.gr}_${pName}`]?.size > 1,
                ctr: r.view > 0 ? (r.click / r.view * 100) : 0, 
                cpc: r.click > 0 ? (r.cost / r.click) : 0, 
                roas: r.cost > 0 ? (r.amt / r.cost * 100) : 0,
                pCtr: r.pView > 0 ? (r.pClick / r.pView * 100) : 0,
                pCpc: r.pClick > 0 ? (r.pCost / r.pClick) : 0,
                pRoas: r.pCost > 0 ? (r.pAmt / r.pCost * 100) : 0
            };
        });

        aggList.sort((a,b) => {
            if(sDir === 'desc') {
                return b[sKey] > a[sKey] ? 1 : -1;
            } else {
                return a[sKey] > b[sKey] ? 1 : -1;
            }
        });
        
        const getDiff = (cur, pre) => {
            if(pre === 0 || pre === null || pre === undefined) return '';
            const d = ((cur - pre) / pre * 100).toFixed(0);
            if(Math.abs(d) < 0.5) return ''; // 0.5% ë¯¸ë§Œ ë³€í™”ëŠ” í‘œì‹œ ì•ˆí•¨
            if(d > 0) return `<span class="diff up">(â–²${d}%)</span>`;
            if(d < 0) return `<span class="diff down">(â–¼${Math.abs(d)}%)</span>`;
            return '';
        };

        document.getElementById('tableBody').innerHTML = aggList.map(r => `
            <tr onclick="viewDetail('${r.mat}')" style="cursor:pointer;">
                <td><img src="${r.pImg}" class="img-thumb" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E'"></td>
                <td class="col-campaign" style="color:#2b6cb0;" title="${r.cp}">${r.cp}</td>
                <td class="col-adgroup" style="color:#c05621;" title="${r.gr}">${r.gr}</td>
                <td class="col-product" title="${r.pName}"><b>${r.pName}</b>${r.isG?'<span class="badge-group">ê·¸ë£¹</span>':''}</td>
                <td>${r.cost.toLocaleString()}${getDiff(r.cost, r.pCost)}</td>
                <td>${r.view.toLocaleString()}${getDiff(r.view, r.pView)}</td>
                <td>${r.click.toLocaleString()}${getDiff(r.click, r.pClick)}</td>
                <td>${r.ctr.toFixed(2)}%${getDiff(r.ctr, r.pCtr)}</td>
                <td>${Math.round(r.cpc).toLocaleString()}${getDiff(r.cpc, r.pCpc)}</td>
                <td>${r.cv}${getDiff(r.cv, r.pCv)}</td>
                <td style="font-weight:bold">${r.amt.toLocaleString()}${getDiff(r.amt, r.pAmt)}</td>
                <td style="color:green; font-weight:bold;">${r.roas.toFixed(0)}%${getDiff(r.roas, r.pRoas)}</td>
            </tr>`).join('');
    }

    function resort(k) { 
        sKey = k; 
        sDir = sDir === 'desc' ? 'asc' : 'desc'; 
        refresh(); 
    }

    function viewDetail(mat) {
        activeMat = mat;
        document.getElementById('detailSection').style.display = 'block';
        document.getElementById('detailTitle').innerText = `[ì „ì²´ ê¸°ê°„] ${pMap[mat]?.name || mat}`;
        
        let th = '';
        for(let k in metricNames) {
            th += `<button class="tab-btn ${metric===k?'active':''}" onclick="setMetric('${k}')">${metricNames[k]}</button>`;
        }
        document.getElementById('tabArea').innerHTML = th;
        
        drawCharts();
        setTimeout(() => {
            document.getElementById('detailSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    function setMetric(m) { 
        metric = m; 
        drawCharts();
    }

    function drawCharts() {
        const filteredData = raw.filter(d => d.mat === activeMat);
        
        // ì¼ë³„ ì§‘ê³„
        const dayMap = {};
        filteredData.forEach(d => {
            if(!dayMap[d.date]) dayMap[d.date] = { date: d.date, cost:0, view:0, click:0, cv:0, amt:0 };
            dayMap[d.date].cost += d.cost; 
            dayMap[d.date].view += d.view; 
            dayMap[d.date].click += d.click; 
            dayMap[d.date].cv += d.cv; 
            dayMap[d.date].amt += d.amt;
        });
        
        const dData = Object.values(dayMap).sort((a,b) => a.date.localeCompare(b.date));
        
        // ì£¼ë³„ ì§‘ê³„
        const wMap = {};
        filteredData.forEach(d => {
            if(!wMap[d.week]) wMap[d.week] = { cost:0, view:0, click:0, cv:0, amt:0 };
            wMap[d.week].cost += d.cost; 
            wMap[d.week].view += d.view; 
            wMap[d.week].click += d.click; 
            wMap[d.week].cv += d.cv; 
            wMap[d.week].amt += d.amt;
        });

        const getValue = (o) => {
            if(metric === 'ctr') return o.view > 0 ? (o.click / o.view * 100) : 0;
            if(metric === 'cvr') return o.click > 0 ? (o.cv / o.click * 100) : 0;
            if(metric === 'roas') return o.cost > 0 ? (o.amt / o.cost * 100) : 0;
            if(metric === 'cpc') return o.click > 0 ? (o.cost / o.click) : 0;
            return o[metric] || 0;
        };

        const formatValue = (val) => {
            if(['ctr', 'cvr', 'roas'].includes(metric)) return val.toFixed(1) + '%';
            return Math.round(val).toLocaleString();
        };

        // í†µê³„ ë Œë”ë§ í•¨ìˆ˜
        const renderStats = (id, values, prefix) => {
            if(values.length === 0) {
                document.getElementById(id).innerHTML = '';
                return;
            }
            const max = Math.max(...values);
            const min = Math.min(...values);
            const avg = values.reduce((a,b)=>a+b,0) / values.length;
            
            document.getElementById(id).innerHTML = `
                <div class="stat-item"><div class="stat-label">${prefix} ìµœê³ </div><div class="stat-value max">${formatValue(max)}</div></div>
                <div class="stat-item"><div class="stat-label">${prefix} ìµœì €</div><div class="stat-value min">${formatValue(min)}</div></div>
                <div class="stat-item"><div class="stat-label">${prefix} í‰ê· </div><div class="stat-value">${formatValue(avg)}</div></div>
            `;
        };

        // ì¼ë³„ ì°¨íŠ¸
        if(dChart) dChart.destroy();
        const dayLabels = dData.map(d => d.date);
        const dayValues = dData.map(d => getValue(d));
        
        renderStats('dayStats', dayValues, 'ì¼'); // ì¼ë³„ í†µê³„ í‘œì‹œ

        dChart = new Chart(document.getElementById('dayChart'), {
            type: 'line',
            data: {
                labels: dayLabels,
                datasets: [{
                    label: metricNames[metric],
                    data: dayValues,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 13 },
                        bodyFont: { size: 14, weight: 'bold' },
                        callbacks: {
                            label: (context) => metricNames[metric] + ': ' + formatValue(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatValue(value)
                        },
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // ìµœê·¼ 4ì£¼ë§Œ í•„í„°ë§
        const weekKeys = Object.keys(wMap).sort().slice(-4);
        const weekValues = weekKeys.map(k => getValue(wMap[k]));
        
        renderStats('weekStats', weekValues, 'ì£¼'); // ì£¼ë³„ í†µê³„ í‘œì‹œ
        
        // ìµœê·¼ ì£¼ëŠ” ì§„í•œ íŒŒë€ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” ì—°í•œ í•˜ëŠ˜ìƒ‰ íŒŒìŠ¤í…”í†¤
        const weekColors = weekKeys.map((k, idx) => 
            idx === weekKeys.length - 1 ? '#5DADE2' : '#D6EAF8'
        );
        
        // ì£¼ë³„ ì°¨íŠ¸
        if(wChart) wChart.destroy();
        wChart = new Chart(document.getElementById('weekChart'), {
            type: 'bar',
            data: {
                labels: weekKeys,
                datasets: [{
                    label: metricNames[metric],
                    data: weekValues,
                    backgroundColor: weekColors,
                    borderColor: '#fff',
                    borderWidth: 2,
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        color: '#2c3e50',
                        font: { weight: 'bold', size: 13 },
                        formatter: (value) => formatValue(value)
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 13 },
                        bodyFont: { size: 14, weight: 'bold' },
                        callbacks: {
                            label: (context) => metricNames[metric] + ': ' + formatValue(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => formatValue(value)
                        },
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>
</body>
</html>