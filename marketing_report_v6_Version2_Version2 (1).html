<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marketing Report v6</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; margin-bottom: 12px; }
    .control { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: #444; }
    select, input { padding: 8px; min-width: 220px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
    th { background: #f4f4f4; text-align: left; }
    .muted { color: #666; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; font-size: 12px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px; min-width: 220px; }
    .card h3 { margin: 0 0 8px 0; font-size: 14px; }
    .kpi { font-size: 22px; font-weight: 700; }
  </style>
</head>
<body>
  <h1>Marketing Report <span class="pill">v6</span></h1>
  <p class="muted">Interactive HTML report. Use filters below to slice the data.</p>

  <div class="controls" id="controls">
    <div class="control">
      <label for="dateFrom">Date from</label>
      <input type="date" id="dateFrom" />
    </div>
    <div class="control">
      <label for="dateTo">Date to</label>
      <input type="date" id="dateTo" />
    </div>

    <!-- IMPORTANT: Keep campaign type filter (do NOT remove). -->
    <div class="control" id="campaignTypeControl">
      <label for="campaignType">Campaign type</label>
      <select id="campaignType"></select>
    </div>

    <!-- IMPORTANT: Keep original product-name filtering behavior (no search-change request). -->
    <div class="control" id="productNameControl">
      <label for="productName">Product name</label>
      <select id="productName"></select>
    </div>

    <div class="control">
      <label for="channel">Channel</label>
      <select id="channel"></select>
    </div>

    <div class="control">
      <label>&nbsp;</label>
      <button id="applyBtn">Apply</button>
    </div>
    <div class="control">
      <label>&nbsp;</label>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="row" id="kpis"></div>

  <h2>Campaign Analysis</h2>
  <table>
    <thead>
      <tr>
        <th>Campaign</th>
        <th>Type</th>
        <th>Channel</th>
        <th>Product</th>
        <th>Spend</th>
        <th>Revenue</th>
        <th>ROAS</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    // ----- Data (example / placeholder) -----
    // In the real report, this would be embedded/loaded. We preserve existing behavior.
    const data = window.__MARKETING_REPORT_DATA__ || [
      { date: '2025-12-01', campaign: 'Holiday Push', type: 'Search', channel: 'Google', product: 'Widget A', spend: 1200, revenue: 4200 },
      { date: '2025-12-02', campaign: 'Holiday Push', type: 'Search', channel: 'Google', product: 'Widget B', spend: 800, revenue: 2100 },
      { date: '2025-12-03', campaign: 'Brand Lift', type: 'Display', channel: 'Meta', product: 'Widget A', spend: 600, revenue: 900 },
      { date: '2025-12-03', campaign: 'Retargeting', type: 'Display', channel: 'Meta', product: 'Widget C', spend: 400, revenue: 1100 },
    ];

    // ----- Helpers -----
    const $ = (id) => document.getElementById(id);
    const fmtMoney = (n) => (Number(n || 0)).toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    function uniq(arr) {
      return Array.from(new Set(arr)).sort((a, b) => String(a).localeCompare(String(b)));
    }

    function withinDate(d, from, to) {
      if (!from && !to) return true;
      const x = new Date(d + 'T00:00:00Z').getTime();
      const f = from ? new Date(from + 'T00:00:00Z').getTime() : -Infinity;
      const t = to ? new Date(to + 'T00:00:00Z').getTime() : Infinity;
      return x >= f && x <= t;
    }

    function populateSelect(selectEl, values, { includeAll = true, allLabel = 'All' } = {}) {
      selectEl.innerHTML = '';
      if (includeAll) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = allLabel;
        selectEl.appendChild(opt);
      }
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
    }

    // ----- Filters state -----
    const state = {
      dateFrom: '',
      dateTo: '',
      campaignType: '',
      productName: '',
      channel: '',
    };

    function readStateFromUI() {
      state.dateFrom = $('dateFrom').value;
      state.dateTo = $('dateTo').value;
      state.campaignType = $('campaignType').value;
      state.productName = $('productName').value;
      state.channel = $('channel').value;
    }

    function writeStateToUI() {
      $('dateFrom').value = state.dateFrom;
      $('dateTo').value = state.dateTo;
      $('campaignType').value = state.campaignType;
      $('productName').value = state.productName;
      $('channel').value = state.channel;
    }

    function resetState() {
      state.dateFrom = '';
      state.dateTo = '';
      state.campaignType = '';
      state.productName = '';
      state.channel = '';
      writeStateToUI();
      render();
    }

    function filterData(rows) {
      return rows.filter(r => {
        if (!withinDate(r.date, state.dateFrom, state.dateTo)) return false;
        if (state.campaignType && r.type !== state.campaignType) return false;
        if (state.productName && r.product !== state.productName) return false;
        if (state.channel && r.channel !== state.channel) return false;
        return true;
      });
    }

    function computeKPIs(rows) {
      const spend = rows.reduce((s, r) => s + Number(r.spend || 0), 0);
      const revenue = rows.reduce((s, r) => s + Number(r.revenue || 0), 0);
      const roas = spend > 0 ? revenue / spend : 0;
      return { spend, revenue, roas };
    }

    function renderKPIs(rows) {
      const { spend, revenue, roas } = computeKPIs(rows);
      $('kpis').innerHTML = '';
      const cards = [
        { title: 'Spend', value: fmtMoney(spend) },
        { title: 'Revenue', value: fmtMoney(revenue) },
        { title: 'ROAS', value: roas ? roas.toFixed(2) : '0.00' },
      ];
      cards.forEach(c => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<h3>${c.title}</h3><div class="kpi">${c.value}</div>`;
        $('kpis').appendChild(el);
      });
    }

    function renderTable(rows) {
      const tb = $('tbody');
      tb.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const roas = r.spend > 0 ? (r.revenue / r.spend) : 0;
        tr.innerHTML = `
          <td>${r.campaign}</td>
          <td>${r.type}</td>
          <td>${r.channel}</td>
          <td>${r.product}</td>
          <td>${fmtMoney(r.spend)}</td>
          <td>${fmtMoney(r.revenue)}</td>
          <td>${roas.toFixed(2)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function render() {
      readStateFromUI();
      const rows = filterData(data);
      renderKPIs(rows);
      renderTable(rows);
    }

    function init() {
      // Populate filter dropdowns from data
      populateSelect($('campaignType'), uniq(data.map(d => d.type)), { includeAll: true, allLabel: 'All types' });
      populateSelect($('productName'), uniq(data.map(d => d.product)), { includeAll: true, allLabel: 'All products' });
      populateSelect($('channel'), uniq(data.map(d => d.channel)), { includeAll: true, allLabel: 'All channels' });

      $('applyBtn').addEventListener('click', render);
      $('resetBtn').addEventListener('click', resetState);

      // Initial render
      render();
    }

    init();
  </script>
</body>
</html>
