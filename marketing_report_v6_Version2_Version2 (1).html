<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (4ì£¼)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 2200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 15px; }
        .header-title-group { display: flex; align-items: baseline; gap: 15px; }
        .header h1 { font-size: 32px; color: #333; font-weight: bold; }
        .header-date { font-size: 14px; color: #666; font-weight: normal; background: #f0f0f0; padding: 4px 10px; border-radius: 12px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .nav-tabs button { padding: 12px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-tabs button:hover { color: #007bff; }
        .nav-tabs button.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .section { margin-bottom: 50px; }
        .section-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; display:flex; justify-content: space-between; align-items: center; gap:12px; }
        .controls { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .controls input, .controls select, .controls button { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; height: 36px; }
        .controls select { max-width: 160px; }
        .controls button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; white-space: nowrap; }
        .controls button:hover { background-color: #0056b3; }
        .controls button.danger { background-color: #dc3545; }
        .controls button.danger:hover { background-color: #c82333; }
        .controls button.secondary { background: #6c757d; color: #fff; }
        .controls button.secondary:hover { background: #5a6268; }
        .controls button.btn-compact { padding: 8px 8px; font-size: 11px; letter-spacing: -0.5px; }
        
        .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 13px; }
        .status { padding: 15px; border-radius: 4px; margin-top: 15px; display: none; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; max-height: 700px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto; }
        th { padding: 10px 6px; text-align: left; font-weight: bold; color: white; background: #007bff; border-bottom: 2px solid #0056b3; white-space: nowrap; position: sticky; top: 0; cursor: pointer; user-select: none; z-index: 10; }
        td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: left; }
        th:hover { background: #0056b3; }
        th.sort-asc::after { content: ' â–²'; }
        th.sort-desc::after { content: ' â–¼'; }
        td.number, th.number { white-space: nowrap; }
        .text-col { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr:hover { background: #f9f9f9; }
        tr.filtered-out { display: none !important; }
        tr.low-roas { background-color: #ffecec !important; }
        tr.total-row, tr.prev-total-row { background-color: #e3f2fd !important; font-weight: bold; border-bottom: 2px solid #bbdefb; }
        tr.total-row td, tr.prev-total-row td { color: #0d47a1; }
        tr.total-row:hover, tr.prev-total-row:hover { background-color: #bbdefb !important; }
        .no-data { text-align: center; padding: 40px 20px; color: #999; font-size: 16px; }
        .rank-badge { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; background: #007bff; color: white; font-weight: bold; font-size: 11px; text-align: center; }
        
        .detail-row { background: #f7fbff; }
        .detail-row td div { display: flex; flex-wrap: nowrap; gap: 12px; align-items: center; width: 100%; padding: 6px 4px; font-size: 11px; color: #444; white-space: nowrap; }
        .detail-row strong { margin-right: 8px; color: #333; font-size: 12px; min-width: 80px; }
        .badge-mini { font-size: 11px; color: #666; margin-left: 4px; white-space: nowrap; }
        .hide-changes .badge-mini { display: none !important; }
        .pagination { display: flex; gap: 8px; align-items: center; font-size: 12px; margin: 10px 0; }
        .pagination button { padding: 6px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .chart-container { background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 30px; border: 1px solid #ddd; }
        .chart-wrapper { position: relative; height: 220px; width: 100%; }
        /* 4ê°œì”© 3ì¤„ */
        .chart-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 20px; row-gap: 32px; }
        .chart-caption { font-size: 12px; color: #444; margin-bottom: 4px; }
        .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); gap: 16px; }

        /* ì¹´ë“œ 6ê°œì”© 2ì¤„ */
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
        .stat-card { background: #f9fafb; border: 1px solid #e3e6ea; border-radius: 8px; padding: 16px; min-height: 140px; display: flex; flex-direction: column; gap: 12px; }
        .stat-title { font-size: 13px; font-weight: 700; color: #444; }
        .stat-value-main { font-size: 28px; font-weight: 800; color: #111; }
        .delta-box { background: #fff; border: 1px solid #e3e6ea; border-radius: 6px; padding: 10px 12px; display: flex; flex-direction: column; gap: 8px; }
        .delta-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #444; }
        .delta-label { color: #444; }
        .delta-val { font-weight: 700; }
        .delta-up { color: #2e8b57; }
        .delta-down { color: #c0392b; }
        .delta-icon { margin-right: 6px; font-weight: 900; }

        /* ìˆœìœ„ ë¶„ì„ ìŠ¤íƒ€ì¼ */
        .rank-heatmap-table th, .rank-heatmap-table td { text-align: center; border: 1px solid #eee; padding: 8px; font-size: 11px; }
        .rank-heatmap-table th { background: #f8f9fa; font-weight: bold; }
        
        /* Drag and drop upload styles */
        .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .drop-zone { border: 2px dashed #007bff; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa; transition: all 0.3s; cursor: pointer; position: relative; }
        .drop-zone:hover { background: #e7f3ff; border-color: #0056b3; }
        .drop-zone.dragover { background: #d4edff; border-color: #0056b3; }
        .drop-zone.uploaded { border-color: #28a745; background: #d4edda; }
        .drop-zone-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #333; }
        .drop-zone-hint { font-size: 11px; color: #666; }
        .drop-zone-status { font-size: 12px; margin-top: 8px; color: #28a745; font-weight: bold; }
        .drop-zone input[type="file"] { display: none; }
        
        /* Sticky total rows */
        .sticky-total-row { position: sticky; top: 42px; z-index: 9; background-color: #e3f2fd !important; }
        .sticky-total-row.row-0 { top: 42px; }
        .sticky-total-row.row-1 { top: 84px; }
        .sticky-total-row.row-2 { top: 126px; }
        
        /* TOP 10 tables for Rank Analysis */
        .top10-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .top10-table-wrapper { border: 1px solid #ddd; border-radius: 6px; overflow: hidden; background: white; }
        .top10-title { background: #007bff; color: white; padding: 10px; font-size: 13px; font-weight: bold; text-align: center; }
        .top10-table { width: 100%; font-size: 11px; }
        .top10-table th { background: #f8f9fa; padding: 6px; text-align: left; font-size: 11px; border-bottom: 1px solid #ddd; }
        .top10-table td { padding: 6px; border-bottom: 1px solid #f0f0f0; text-align: left; }
        .top10-table td:first-child { font-weight: bold; color: #007bff; }
        .top10-table td:last-child { text-align: right; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-title-group">
            <h1>ğŸ“Š ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (ìµœê·¼ 4ì£¼)</h1>
            <span id="mainDateRange" class="header-date"></span>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'upload')">ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ</button>
        <button class="tab-btn" onclick="switchTab(event, 'overview')">ğŸ“ˆ ì„±ê³¼ ìš”ì•½</button>
        <button class="tab-btn" onclick="switchTab(event, 'rank')">ğŸ† ìˆœìœ„ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'campaign')">ğŸ¯ ìº í˜ì¸ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'adgroup')">ğŸ§© ê´‘ê³ ê·¸ë£¹ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'keyword')">ğŸ” í‚¤ì›Œë“œ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'creative')">ğŸ¨ ì†Œì¬ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'media')">ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'efficiency')">âš¡ íš¨ìœ¨ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'cpc')">ğŸ’² CPC ë¶„ì„</button>
        <button class="tab-btn" onclick="switchTab(event, 'device')">ğŸ“± ë””ë°”ì´ìŠ¤ ë¶„ì„</button>
    </div>

    <!-- TAB 1: Upload -->
    <div id="upload" class="tab-content active">
        <div class="section" id="section-upload">
            <div class="section-title">
                <span>ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ</span>
            </div>
            <div class="info-box">
                ğŸ’¡ 4ê°œì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ):<br>
                â€¢ RAW (CSV/XLSX): ì¼ë³„/ì£¼ë³„, ì‹œê°„ëŒ€/ìš”ì¼ í¬í•¨ ë°ì´í„°<br>
                â€¢ Search Query (CSV/XLSX): ê²€ìƒ‰ì–´ë³„ ì„±ê³¼ ë°ì´í„°<br>
                â€¢ Creative (CSV): ì†Œì¬ë³„ ì„±ê³¼ ë°ì´í„°<br>
                â€¢ Product Info (TSV): ìƒí’ˆ ì •ë³´ ë°ì´í„°
            </div>
            <div class="upload-grid">
                <div class="drop-zone" id="dropZoneRaw" onclick="document.getElementById('fileInputRaw').click()">
                    <div class="drop-zone-title">ğŸ“Š RAW</div>
                    <div class="drop-zone-hint">CSV/XLSX íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                    <div class="drop-zone-status" id="statusRaw"></div>
                    <input type="file" id="fileInputRaw" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw')">
                </div>
                <div class="drop-zone" id="dropZoneRaw2" onclick="document.getElementById('fileInputRaw2').click()">
                    <div class="drop-zone-title">ğŸ” Search Query</div>
                    <div class="drop-zone-hint">CSV/XLSX íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                    <div class="drop-zone-status" id="statusRaw2"></div>
                    <input type="file" id="fileInputRaw2" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw2')">
                </div>
                <div class="drop-zone" id="dropZoneCreative" onclick="document.getElementById('fileInputCreative').click()">
                    <div class="drop-zone-title">ğŸ¨ Creative</div>
                    <div class="drop-zone-hint">CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                    <div class="drop-zone-status" id="statusCreative"></div>
                    <input type="file" id="fileInputCreative" accept=".csv" onchange="handleUpload(event, 'creative')">
                </div>
                <div class="drop-zone" id="dropZoneProduct" onclick="document.getElementById('fileInputProduct').click()">
                    <div class="drop-zone-title">ğŸ“¦ Product Info</div>
                    <div class="drop-zone-hint">TSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                    <div class="drop-zone-status" id="statusProduct"></div>
                    <input type="file" id="fileInputProduct" accept=".tsv" onchange="handleUpload(event, 'product')">
                </div>
            </div>
            <div id="uploadStatus" class="status"></div>
        </div>
    </div>

    <!-- TAB 2: Overview -->
    <div id="overview" class="tab-content">
        <div class="section" id="section-overview">
            <div class="section-title">
                <span>ğŸ“ˆ ì„±ê³¼ ìš”ì•½</span>
            </div>
            <div id="statsContainer" class="stat-grid"></div>
            
            <!-- ì£¼ê°„ ì¶”ì´ ì°¨íŠ¸ -->
            <div class="chart-container">
                <h3 id="weekCompareTitle" style="margin-bottom: 16px;">ì£¼ê°„ ì„±ê³¼ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h3>
                <div class="chart-grid" id="overviewCharts"></div>
            </div>

            <!-- ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ -->
            <div class="chart-container" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“Š í•­ëª©ë³„ ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ (100%)</h3>
                    <div class="controls" style="margin: 0;">
                        <select id="stackChartType" onchange="updateStackedChart()">
                            <option value="campaignType">ìº í˜ì¸ ìœ í˜•ë³„</option>
                            <option value="campaign" selected>ìº í˜ì¸ë³„</option>
                            <option value="adgroup">ê´‘ê³ ê·¸ë£¹ë³„</option>
                            <option value="device">ë””ë°”ì´ìŠ¤ë³„</option>
                        </select>
                        <select id="stackLimit" onchange="updateStackedChart()">
                            <option value="0" selected>ì „ì²´ ë³´ê¸°</option>
                            <option value="5">ìƒìœ„ 5ê°œ</option>
                            <option value="10">ìƒìœ„ 10ê°œ</option>
                            <option value="20">ìƒìœ„ 20ê°œ</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper" style="height: 400px;">
                    <canvas id="stackedBarChart"></canvas>
                </div>
                <p style="font-size:12px; color:#666; text-align:right; margin-top:5px;">* ì°¨íŠ¸ì˜ ë§‰ëŒ€ë‚˜ ë²”ë¡€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ê°•ì¡°ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- TAB New: Rank Analysis -->
    <div id="rank" class="tab-content">
        <div class="section">
            <div class="section-title">
                <span>ğŸ† ìˆœìœ„ ë¶„ì„</span>
            </div>
            
            <!-- TOP 10 Search Terms -->
            <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3 style="margin-bottom:15px;">ğŸ” ê²€ìƒ‰ì–´ TOP 10</h3>
                <div id="top10Container" class="top10-grid"></div>
            </div>
            
            <div class="rank-panel" style="margin-bottom:20px; background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3>ğŸ“‰ ê²€ìƒ‰ì–´ë³„ ìˆœìœ„ ì¶”ì´ (ìµœê·¼ 14ì¼)</h3>
                <div class="controls" style="margin-top:10px;">
                    <select id="trendCT" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                    <select id="trendCamp" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                    <select id="trendAdg" onchange="updateRankTrend()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                    <select id="trendMedia" onchange="updateRankTrend()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                    <input type="text" id="trendKw" placeholder="ê²€ìƒ‰ì–´ (ì‰¼í‘œë¡œ êµ¬ë¶„: í‚¤ì›Œë“œ1, í‚¤ì›Œë“œ2)" style="width:300px;" onchange="updateRankTrend()">
                    <button onclick="updateRankTrend()">ì¡°íšŒ</button>
                </div>
                <div style="height:350px;">
                    <canvas id="rankTrendChart"></canvas>
                </div>
            </div>

            <div class="rank-panel" style="background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
                <h3>â° ì‹œê°„ëŒ€/ìš”ì¼ë³„ í‰ê·  ìˆœìœ„ (Heatmap)</h3>
                <div class="controls" style="margin-top:10px;">
                    <select id="heatCT" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                    <select id="heatCamp" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                    <select id="heatAdg" onchange="updateRankHeatmap()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                    <select id="heatMedia" onchange="updateRankHeatmap()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
                    <button onclick="updateRankHeatmap()">ë¶„ì„</button>
                </div>
                <div id="rankHeatmapContainer" style="overflow-x:auto; margin-top:15px;">
                    <p style="padding:20px; text-align:center; color:#999;">ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  'ë¶„ì„' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìˆœìœ„í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: Campaign -->
    <div id="campaign" class="tab-content">
        <div class="section" id="section-campaign">
            <div class="section-title">
                <span>ğŸ¯ ìº í˜ì¸ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="campaignFilter" placeholder="ìº í˜ì¸ ê²€ìƒ‰" onkeyup="updateCampaignTable()">
                <select id="campaignTypeFilter" onchange="updateCampaignTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="campaignDeviceFilter" onchange="updateCampaignTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <select id="campaignCampaignFilter" onchange="updateCampaignTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="campaignAdgroupFilter" onchange="updateCampaignTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="standardROAS" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('campaignBody', 'standardROAS')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('campaignBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('campaignBody', 'up', 'standardROAS')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('campaignBody', 'down', 'standardROAS')">â†“</button>
                <button class="danger" onclick="resetCampaign()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('campaignTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="campaignTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('campaignTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('campaignTable', 1)">ìº í˜ì¸</th>
                        <th onclick="sortTable('campaignTable', 2)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('campaignTable', 3)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('campaignTable', 4)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 5)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 6)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('campaignTable', 7)" class="number">CPC</th>
                        <th onclick="sortTable('campaignTable', 8)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('campaignTable', 9)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('campaignTable', 10)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('campaignTable', 11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('campaignTable', 12)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="campaignBody">
                    <tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 4: Adgroup -->
    <div id="adgroup" class="tab-content">
        <div class="section" id="section-adgroup">
            <div class="section-title">
                <span>ğŸ§© ê´‘ê³ ê·¸ë£¹ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="adgroupFilter" placeholder="ê´‘ê³ ê·¸ë£¹ ê²€ìƒ‰" onkeyup="updateAdgroupTable()">
                <select id="adgroupCampaignFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="adgroupCampaignTypeFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="adgroupDeviceFilter" onchange="updateAdgroupTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS_AG" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('adgroupBody', 'standardROAS_AG')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('adgroupBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('adgroupBody', 'up', 'standardROAS_AG')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('adgroupBody', 'down', 'standardROAS_AG')">â†“</button>
                <button class="danger" onclick="resetAdgroup()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('adgroupTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="adgroupTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('adgroupTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('adgroupTable', 1)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('adgroupTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('adgroupTable', 3)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('adgroupTable', 4)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('adgroupTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 6)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 7)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('adgroupTable', 8)" class="number">CPC</th>
                        <th onclick="sortTable('adgroupTable', 9)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('adgroupTable', 10)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('adgroupTable', 11)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('adgroupTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('adgroupTable', 13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="adgroupBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 5: Keyword -->
    <div id="keyword" class="tab-content">
        <div class="section" id="section-keyword">
            <div class="section-title">
                <span>ğŸ” í‚¤ì›Œë“œ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="keywordSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰" onkeyup="updateKeywordTable(true)">
                <select id="keywordCampaignTypeFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="keywordCampaignFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="keywordAdgroupFilter" onchange="updateKeywordTable(true)"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <select id="deviceFilter" onchange="updateKeywordTable(true)"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS2" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('keywordBody', 'standardROAS2')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('keywordBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('keywordBody', 'up', 'standardROAS2')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('keywordBody', 'down', 'standardROAS2')">â†“</button>
                <button class="danger" onclick="resetKeyword()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('keywordTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="pagination">
                <button id="kwPrev" onclick="changeKeywordPage(-1)">ì´ì „</button>
                <span id="kwPageInfo">0 / 0</span>
                <button id="kwNext" onclick="changeKeywordPage(1)">ë‹¤ìŒ</button>
            </div>
            <div class="table-wrapper">
                <table id="keywordTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('keywordTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('keywordTable', 1)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('keywordTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('keywordTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('keywordTable', 4)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('keywordTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 6)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 7)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('keywordTable', 8)" class="number">CPC</th>
                        <th onclick="sortTable('keywordTable', 9)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('keywordTable', 10)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('keywordTable', 11)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('keywordTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('keywordTable', 13)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="keywordBody">
                    <tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 6: Creative Analysis -->
    <div id="creative" class="tab-content">
        <div class="section" id="section-creative">
            <div class="section-title">
                <span>ğŸ¨ ì†Œì¬ ë¶„ì„ (Creative Analysis)</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="creativeProductSearch" placeholder="ìƒí’ˆëª… ê²€ìƒ‰" onkeyup="updateCreativeTable()">
                <select id="creativeCampaignFilter" onchange="updateCreativeTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="creativeAdgroupFilter" onchange="updateCreativeTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <button class="danger" onclick="resetCreative()">ì´ˆê¸°í™”</button>
            </div>
            <div class="table-wrapper">
                <table id="creativeTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('creativeTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('creativeTable', 1)">ì´ë¯¸ì§€</th>
                        <th onclick="sortTable('creativeTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('creativeTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('creativeTable', 4)">ìƒí’ˆëª…</th>
                        <th onclick="sortTable('creativeTable', 5)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('creativeTable', 6)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('creativeTable', 7)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('creativeTable', 8)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('creativeTable', 9)" class="number">CPC</th>
                        <th onclick="sortTable('creativeTable', 10)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('creativeTable', 11)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('creativeTable', 12)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="creativeBody">
                    <tr><td colspan="13" class="no-data">Creative ë° Product íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 7: Media -->
    <div id="media" class="tab-content">
        <div class="section" id="section-media">
            <div class="section-title">
                <span>ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</span>
            </div>
            <div class="controls">
                <input class="text-col" type="text" id="mediaFilter" placeholder="ë§¤ì²´ ê²€ìƒ‰" onkeyup="updateMediaTable()">
                <select id="mediaCampaignTypeFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="mediaCampaignFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="mediaAdgroupFilter" onchange="updateMediaTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <select id="mediaDeviceFilter" onchange="updateMediaTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
                <input type="number" id="standardROAS_MEDIA" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="highlightLowROAS('mediaBody', 'standardROAS_MEDIA')">ROAS ì ìš©</button>
                <button class="filter-red" onclick="filterRedRows('mediaBody')">í•„í„°ë§</button>
                <button class="roas-up" onclick="applyROASFilter('mediaBody', 'up', 'standardROAS_MEDIA')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilter('mediaBody', 'down', 'standardROAS_MEDIA')">â†“</button>
                <button class="danger" onclick="resetMedia()">ì´ˆê¸°í™”</button>
                <button class="secondary" onclick="toggleChangeBadge('mediaTable')">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <div class="table-wrapper">
                <table id="mediaTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('mediaTable', 0)">ìˆœìœ„</th>
                        <th onclick="sortTable('mediaTable', 1)">ë§¤ì²´</th>
                        <th onclick="sortTable('mediaTable', 2)">ìº í˜ì¸</th>
                        <th onclick="sortTable('mediaTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('mediaTable', 4)">ë””ë°”ì´ìŠ¤</th>
                        <th onclick="sortTable('mediaTable', 5)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('mediaTable', 6)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('mediaTable', 7)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 8)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 9)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('mediaTable', 10)" class="number">CPC</th>
                        <th onclick="sortTable('mediaTable', 11)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('mediaTable', 12)" class="number">ì „í™˜ìœ¨</th>
                        <th onclick="sortTable('mediaTable', 13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('mediaTable', 14)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('mediaTable', 15)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="mediaBody">
                    <tr><td colspan="16" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 7: Efficiency -->
    <div id="efficiency" class="tab-content">
        <div class="section" id="section-efficiency">
            <div class="section-title">
                <span>âš¡ íš¨ìœ¨ë¶„ì„</span>
            </div>
            <div class="info-box">ğŸ’¡ í•„í„°ë§ ì¡°ê±´(ìµœì†Œ ê´‘ê³ ë¹„, ìµœì†Œ ì „í™˜ìˆ˜ ë“±)ì„ ëª¨ë‘ ë§Œì¡±í•˜ë©´ íš¨ìœ¨ GOOD, ì•„ë‹ˆë©´ BAD.</div>
            <div class="controls">
                <input class="text-col" type="text" id="brandExclude" placeholder="ì œì™¸ í‚¤ì›Œë“œ(ì½¤ë§ˆ)">
                <select id="efficiencyCampaignTypeFilter"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <select id="efficiencyCampaignFilter"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="efficiencyAdgroupFilter"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="filterCostMin" placeholder="ìµœì†Œ ê´‘ê³ ë¹„">
                <input type="number" id="filterConvMin" placeholder="ìµœì†Œ ì „í™˜ìˆ˜">
                <input type="number" id="filterROASMin" placeholder="ìµœì†Œ ROAS">
                <input type="number" id="filterCPAMin" placeholder="ìµœì†Œ ì „í™˜ë‹¹ë¹„ìš©">
                <button onclick="updateEfficiencyAnalysis()">ğŸ” ì ìš©</button>
                <button class="danger" onclick="resetEfficiency()">ì´ˆê¸°í™”</button>
                <button class="secondary btn-compact" onclick="toggleChangeBadge('goodEfficiencyTable'); toggleChangeBadge('badEfficiencyTable');">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">âœ… íš¨ìœ¨ GOOD (í•„í„° ì¶©ì¡±)</h3>
            <div class="table-wrapper">
                <table id="goodEfficiencyTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('goodEfficiencyTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('goodEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('goodEfficiencyTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('goodEfficiencyTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('goodEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('goodEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('goodEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('goodEfficiencyTable',9)" class="number">CPC</th>
                        <th onclick="sortTable('goodEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('goodEfficiencyTable',11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('goodEfficiencyTable',12)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="goodEfficiencyBody">
                    <tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">âŒ íš¨ìœ¨ BAD (í•„í„° ë¯¸ì¶©ì¡±)</h3>
            <div class="table-wrapper">
                <table id="badEfficiencyTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('badEfficiencyTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('badEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('badEfficiencyTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('badEfficiencyTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('badEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('badEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('badEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('badEfficiencyTable',9)" class="number">CPC</th>
                        <th onclick="sortTable('badEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('badEfficiencyTable',11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                        <th onclick="sortTable('badEfficiencyTable',12)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="badEfficiencyBody">
                    <tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 8: CPC -->
    <div id="cpc" class="tab-content">
        <div class="section" id="section-cpc">
            <div class="section-title">
                <span>ğŸ’² CPC ë¶„ì„</span>
            </div>
            <div class="info-box">ğŸ’¡ í•„í„° ì¡°ê±´ ì¶©ì¡± ì‹œ, CPC ì¦ê°ìœ¨ì— ë”°ë¼ ë¶„ë¥˜ë©ë‹ˆë‹¤.</div>
            <div class="controls">
                <input class="text-col compact-input" type="text" id="cpcBrandExclude" placeholder="ì œì™¸í‚¤ì›Œë“œ">
                <select id="cpcCampaignTypeFilter" class="compact-input"><option value="">ìœ í˜• ì „ì²´</option></select>
                <select id="cpcCampaignFilter" class="compact-input"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
                <select id="cpcAdgroupFilter" class="compact-input"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
                <input type="number" id="cpcCostMin" class="compact-input" placeholder="ê´‘ê³ ë¹„â‰¥">
                <input type="number" id="cpcConvMin" class="compact-input" placeholder="ì „í™˜â‰¥">
                <input type="number" id="cpcROASMin" class="compact-input" placeholder="ROASâ‰¥">
                <input type="number" id="cpcCPAMin" class="compact-input" placeholder="CPAâ‰¤">
                <input type="number" id="cpcChangeThreshold" class="compact-input" placeholder="CPC%">
                <button onclick="updateCPCAnalysis()">ğŸ” ì ìš©</button>
                <button class="danger" onclick="resetCPC()">ì´ˆê¸°í™”</button>
                <button class="secondary btn-compact" onclick="toggleChangeBadge('cpcUpTable'); toggleChangeBadge('cpcDownTable');">ì¦ê°ìœ¨ On/Off</button>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">ğŸ”º CPC ìƒìŠ¹</h3>
            <div class="table-wrapper">
                <table id="cpcUpTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('cpcUpTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('cpcUpTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('cpcUpTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('cpcUpTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('cpcUpTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('cpcUpTable',5)" class="number">CPC</th>
                        <th onclick="sortTable('cpcUpTable',6)" class="number">CPCì¦ê°%</th>
                        <th onclick="sortTable('cpcUpTable',7)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('cpcUpTable',8)" class="number">ê´‘ê³ ë¹„(%)</th>
                        <th onclick="sortTable('cpcUpTable',9)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',10)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',11)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('cpcUpTable',12)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('cpcUpTable',13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('cpcUpTable',14)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="cpcUpBody">
                    <tr><td colspan="15" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
            <h3 style="margin: 20px 0 10px; color: #333;">ğŸ”» CPC ê°ì†Œ</h3>
            <div class="table-wrapper">
                <table id="cpcDownTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable('cpcDownTable',0)">ìˆœìœ„</th>
                        <th onclick="sortTable('cpcDownTable',1)">ìº í˜ì¸ìœ í˜•</th>
                        <th onclick="sortTable('cpcDownTable',2)">ê²€ìƒ‰ì–´</th>
                        <th onclick="sortTable('cpcDownTable',3)">ìº í˜ì¸</th>
                        <th onclick="sortTable('cpcDownTable',4)">ê´‘ê³ ê·¸ë£¹</th>
                        <th onclick="sortTable('cpcDownTable',5)" class="number">CPC</th>
                        <th onclick="sortTable('cpcDownTable',6)" class="number">CPCì¦ê°%</th>
                        <th onclick="sortTable('cpcDownTable',7)" class="number">ê´‘ê³ ë¹„</th>
                        <th onclick="sortTable('cpcDownTable',8)" class="number">ê´‘ê³ ë¹„(%)</th>
                        <th onclick="sortTable('cpcDownTable',9)" class="number">ë…¸ì¶œìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',10)" class="number">í´ë¦­ìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',11)" class="number">í´ë¦­ìœ¨</th>
                        <th onclick="sortTable('cpcDownTable',12)" class="number">ì „í™˜ìˆ˜</th>
                        <th onclick="sortTable('cpcDownTable',13)" class="number">ë§¤ì¶œì•¡</th>
                        <th onclick="sortTable('cpcDownTable',14)" class="number">ROAS</th>
                    </tr>
                    </thead>
                    <tbody id="cpcDownBody">
                    <tr><td colspan="15" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB 9: Device -->
    <div id="device" class="tab-content">
        <div class="section" id="section-device">
            <div class="section-title">
                <span>ğŸ“± ë””ë°”ì´ìŠ¤ë³„ ì„±ê³¼ ë¶„ì„</span>
            </div>
            <div class="controls">
                <select id="deviceCampaignTypeFilter" onchange="updateDeviceTables()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
                <input type="number" id="standardROAS3" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10">
                <button onclick="applyROASFilterDevice('low')">ROAS ì ìš©</button>
                <button class="roas-up" onclick="applyROASFilterDevice('up')">â†‘</button>
                <button class="roas-down" onclick="applyROASFilterDevice('down')">â†“</button>
                <button class="danger" onclick="resetDevice()">ì´ˆê¸°í™”</button>
            </div>
            <div class="two-col">
                <div>
                    <h4 style="margin: 10px 0 10px;">PC</h4>
                    <div class="table-wrapper">
                        <table id="devicePCTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('devicePCTable',0)">ìˆœìœ„</th>
                                <th onclick="sortTable('devicePCTable',1)">ìº í˜ì¸</th>
                                <th onclick="sortTable('devicePCTable',2)" class="number">ê´‘ê³ ë¹„</th>
                                <th onclick="sortTable('devicePCTable',3)" class="number">PCê´‘ê³ ë¹„ì¤‘%</th>
                                <th onclick="sortTable('devicePCTable',4)" class="number">ë…¸ì¶œìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',5)" class="number">í´ë¦­ìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',6)" class="number">ì „í™˜ìˆ˜</th>
                                <th onclick="sortTable('devicePCTable',7)" class="number">ë§¤ì¶œì•¡</th>
                                <th onclick="sortTable('devicePCTable',8)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                                <th onclick="sortTable('devicePCTable',9)" class="number">ROAS</th>
                                <th onclick="sortTable('devicePCTable',10)" class="number">ROAS ì¦ê°%</th>
                            </tr>
                            </thead>
                            <tbody id="devicePCBody">
                            <tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4 style="margin: 10px 0 10px;">MO</h4>
                    <div class="table-wrapper">
                        <table id="deviceMOTable">
                            <thead>
                            <tr>
                                <th onclick="sortTable('deviceMOTable',0)">ìˆœìœ„</th>
                                <th onclick="sortTable('deviceMOTable',1)">ìº í˜ì¸</th>
                                <th onclick="sortTable('deviceMOTable',2)" class="number">ê´‘ê³ ë¹„</th>
                                <th onclick="sortTable('deviceMOTable',3)" class="number">MOê´‘ê³ ë¹„ì¤‘%</th>
                                <th onclick="sortTable('deviceMOTable',4)" class="number">ë…¸ì¶œìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',5)" class="number">í´ë¦­ìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',6)" class="number">ì „í™˜ìˆ˜</th>
                                <th onclick="sortTable('deviceMOTable',7)" class="number">ë§¤ì¶œì•¡</th>
                                <th onclick="sortTable('deviceMOTable',8)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
                                <th onclick="sortTable('deviceMOTable',9)" class="number">ROAS</th>
                                <th onclick="sortTable('deviceMOTable',10)" class="number">ROAS ì¦ê°%</th>
                            </tr>
                            </thead>
                            <tbody id="deviceMOBody">
                            <tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* ============ ë°ì´í„°/ìƒìˆ˜ ============ */
let rawRows = [];
let raw2Rows = [];
let creativeRows = [];
let productMap = {};
let weeks = [];
let currentWeekData = [];
let previousWeekData = [];
let sortDirection = {};
let keywordPage = 1;
const PAGE_SIZE = 100;
const chartKeepers = {};
let stackedChartInstance = null;
const colorPalette = [
    '#5D9CEC', '#4FC1E9', '#48CFAD', '#A0D468', '#FFCE54', '#FC6E51', '#ED5565', '#AC92EC', '#EC87C0',
    '#656D78', '#434A54', '#E6E9ED', '#CCD1D9', '#AAB2BD'
];

const COLS_RAW = { DAY:0, WEEK:1, CAMPAIGN_TYPE:2, CAMPAIGN:3, ADGROUP:4, TIME:5, DOW:6, MEDIA:7, DEVICE:8, COST:9, IMP:10, CLK:11, CONV:12, REV:13, POS:14 };
const COLS_RAW2 = { DAY:0, WEEK:1, CAMPAIGN_TYPE:2, CAMPAIGN:3, ADGROUP:4, KEYWORD:5, MEDIA:6, DEVICE:7, SEARCH_OR_CONTENT:8, COST:9, IMP:10, CLK:11, CONV:12, REV:13, POS:14 };

/* ============ ìœ í‹¸ ============ */
const sum = (arr, key) => arr.reduce((s,d)=>s+(d[key]||0),0);
const formatNum = v => Math.round(v).toLocaleString();
const formatPct2 = v => (v||0).toFixed(2) + '%';
const formatMoney = v => Math.round(v).toLocaleString();
function formatCardValue(key, value){
    if (!value && value!==0) return '-';
    if (['cost','revenue','cpc','cpa','aov'].includes(key)) return formatMoney(value)+'ì›';
    if (['impressions','clicks','conversions'].includes(key)) return formatNum(value);
    if (['ctr','cvr'].includes(key)) return formatPct2(value);
    if (['cor','roas'].includes(key)) return Math.round(value) + '%';
    return formatNum(value);
}
const getChangeRate = (cur, prev) => {
    if (prev === 0) return cur > 0 ? 100 : 0;
    return ((cur - prev) / prev) * 100;
};
const badge = r => `<span class="${r>=0?'delta-up':'delta-down'}">${r>=0?'+':''}${r.toFixed(1)}%</span>`;
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
function showStatus(msg, type) { const s=document.getElementById('uploadStatus'); s.textContent=msg; s.className='status '+type; s.style.display='block'; }
function parseCSVLine(line){ const res=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const c=line[i], n=line[i+1]; if(c==='"'){ if(inQ&&n==='"'){cur+='"'; i++;} else inQ=!inQ; } else if(c===',' && !inQ){ res.push(cur.trim()); cur=''; } else cur+=c; } res.push(cur.trim()); return res; }
function switchTab(e, tabName) {
    e.preventDefault();
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    e.target.classList.add('active');
}
function toggleChangeBadge(tableId) {
    const t = document.getElementById(tableId);
    if(t) t.classList.toggle('hide-changes');
}
function highlightLowROAS(bodyId, inputId) {
    const tbody = document.getElementById(bodyId);
    const val = parseFloat(document.getElementById(inputId).value);
    if(isNaN(val)) return;
    tbody.querySelectorAll('tr[data-roas]').forEach(tr => {
        const r = parseFloat(tr.getAttribute('data-roas'));
        if(r < val) tr.classList.add('low-roas'); else tr.classList.remove('low-roas');
    });
}
function filterRedRows(bodyId) {
    const tbody = document.getElementById(bodyId);
    const mode = tbody.getAttribute('data-filter-mode');
    if (mode === 'on') {
        tbody.querySelectorAll('tr').forEach(tr => tr.classList.remove('filtered-out'));
        tbody.setAttribute('data-filter-mode', 'off');
    } else {
        tbody.querySelectorAll('tr').forEach(tr => {
            if(!tr.classList.contains('low-roas') && !tr.classList.contains('total-row') && !tr.classList.contains('prev-total-row')) {
                 tr.classList.add('filtered-out');
            }
        });
        tbody.setAttribute('data-filter-mode', 'on');
    }
}
function applyROASFilter(bodyId, direction, inputId) {
    const tbody = document.getElementById(bodyId);
    const rows = Array.from(tbody.querySelectorAll('tr.collapsible'));
    rows.sort((a,b) => {
        const ra = parseFloat(a.getAttribute('data-roas'));
        const rb = parseFloat(b.getAttribute('data-roas'));
        return direction === 'up' ? rb - ra : ra - rb;
    });
    rows.forEach(r => {
        tbody.appendChild(r);
        const detail = tbody.querySelector(`tr.detail-row[data-parent="${r.getAttribute('data-key')}"]`);
        if(detail) tbody.appendChild(detail);
    });
}
function clearROASFilter(bodyId) {
    const tbody = document.getElementById(bodyId);
    tbody.querySelectorAll('tr').forEach(tr => {
        tr.classList.remove('low-roas');
        tr.classList.remove('filtered-out');
    });
    tbody.setAttribute('data-filter-mode', 'off');
}
function parseNumber(v){ if(v===undefined||v===null) return 0; return parseFloat(String(v).replace(/,/g,''))||0; }

/* ============ ì—…ë¡œë“œ/íŒŒì‹± ============ */
function handleUpload(ev, kind){
    const file=ev.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            if(kind==='product'){
                parseTSV(e.target.result, kind);
            } else if(kind==='creative'){
                parseCreativeCSV(e.target.result, kind);
            } else if(file.name.endsWith('.csv')) {
                parseCSV(e.target.result,kind);
            } else {
                parseXLSX(e.target.result,kind);
            }
            
            // Update status
            const statusEl = document.getElementById('status' + kind.charAt(0).toUpperCase() + kind.slice(1));
            const dropZoneEl = document.getElementById('dropZone' + kind.charAt(0).toUpperCase() + kind.slice(1));
            if(statusEl) {
                statusEl.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ';
                statusEl.style.display = 'block';
            }
            if(dropZoneEl) {
                dropZoneEl.classList.add('uploaded');
            }
            
            const counts = {
                raw: rawRows.length,
                raw2: raw2Rows.length,
                creative: creativeRows.length,
                product: Object.keys(productMap).length
            };
            showStatus(`âœ… ${kind.toUpperCase()} ë¡œë“œ ì™„ë£Œ: ${counts[kind]}${kind==='product'?'ê°œ':'í–‰'}`, 'success');
            
            if(rawRows.length > 0 || raw2Rows.length > 0) {
                processData();
            }
            if(creativeRows.length > 0 && Object.keys(productMap).length > 0) {
                updateCreativeTable();
            }
        }catch(err){ 
            console.error(err); 
            showStatus('âŒ ì˜¤ë¥˜: '+err.message,'error'); 
        }
    };
    reader.readAsArrayBuffer(file);
}

function parseTSV(buf, kind){
    const text = new TextDecoder('utf-8').decode(buf);
    const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
    productMap = {};
    for(let i=1; i<lines.length; i++){
        const parts = lines[i].split('\t');
        if(parts.length >= 16){
            const matId = parts[2];
            const productName = parts[13];
            const imageUrl = parts[14];
            if(matId) {
                productMap[matId.trim()] = {
                    name: productName || 'ìƒí’ˆëª… ì—†ìŒ',
                    image: imageUrl || ''
                };
            }
        }
    }
}

function parseCreativeCSV(buf, kind){
    let text;
    try {
        // Try EUC-KR encoding first
        text = new TextDecoder('EUC-KR').decode(buf);
    } catch(e) {
        // Fallback to UTF-8 if EUC-KR is not supported
        console.warn('EUC-KR not supported, using UTF-8');
        text = new TextDecoder('utf-8').decode(buf);
    }
    Papa.parse(text, {
        skipEmptyLines: true,
        complete: (result) => {
            if(result.errors && result.errors.length > 0) {
                console.error('CSV parsing errors:', result.errors);
                showStatus('âŒ CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                return;
            }
            if(!result.data || result.data.length === 0) {
                console.error('No data found in CSV');
                showStatus('âŒ CSV íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            const rows = result.data;
            const headRow = rows.findIndex(r => r && r.join && r.join(',').includes('ìº í˜ì¸ìœ í˜•'));
            if(headRow === -1) {
                console.error('Header row not found');
                showStatus('âŒ CSV íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                return;
            }
            creativeRows = rows.slice(headRow + 1)
                .filter(r => r && r[0] === 'ì‡¼í•‘ê²€ìƒ‰')
                .map(r => ({
                    campaignType: r[0],
                    campaign: r[1],
                    adgroup: r[2],
                    material: r[3] ? r[3].trim() : '',
                    date: r[6],
                    week: r[7],
                    cost: parseNumber(r[8]),
                    impressions: parseNumber(r[9]),
                    clicks: parseNumber(r[10]),
                    conversions: parseNumber(r[11]),
                    revenue: parseNumber(r[12])
                }));
        }
    });
}
function parseCSV(buf, kind){
    const text=new TextDecoder('utf-8').decode(buf);
    const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
    const rows=[];
    for(let i=2;i<lines.length;i++){
        const v=parseCSVLine(lines[i]);
        if(kind==='raw' && v.length>=15) rows.push(mapRaw(v));
        if(kind==='raw2' && v.length>=15) rows.push(mapRaw2(v));
    }
    if(kind==='raw') rawRows=rows; else raw2Rows=rows;
}
function parseXLSX(buf, kind){
    const wb=XLSX.read(new Uint8Array(buf), {type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    const mapped=[];
    for(let i=2;i<rows.length;i++){
        const r=rows[i]; if(!r) continue;
        if(kind==='raw' && r.length>=15) mapped.push(mapRaw(r));
        if(kind==='raw2' && r.length>=15) mapped.push(mapRaw2(r));
    }
    if(kind==='raw') rawRows=mapped; else raw2Rows=mapped;
}
function mapRaw(v){
    return { day:v[COLS_RAW.DAY], week:v[COLS_RAW.WEEK], campaignType:v[COLS_RAW.CAMPAIGN_TYPE],
        campaign:v[COLS_RAW.CAMPAIGN], adgroup:v[COLS_RAW.ADGROUP], time:v[COLS_RAW.TIME], dow:v[COLS_RAW.DOW],
        media:v[COLS_RAW.MEDIA], device:v[COLS_RAW.DEVICE],
        cost:parseNumber(v[COLS_RAW.COST]), impressions:parseNumber(v[COLS_RAW.IMP]), clicks:parseNumber(v[COLS_RAW.CLK]),
        conversions:parseNumber(v[COLS_RAW.CONV]), revenue:parseNumber(v[COLS_RAW.REV]), pos:parseNumber(v[COLS_RAW.POS]) };
}
function mapRaw2(v){
    return { day:v[COLS_RAW2.DAY], week:v[COLS_RAW2.WEEK], campaignType:v[COLS_RAW2.CAMPAIGN_TYPE],
        campaign:v[COLS_RAW2.CAMPAIGN], adgroup:v[COLS_RAW2.ADGROUP], keyword:v[COLS_RAW2.KEYWORD],
        media:v[COLS_RAW2.MEDIA], device:v[COLS_RAW2.DEVICE], scType:v[COLS_RAW2.SEARCH_OR_CONTENT],
        cost:parseNumber(v[COLS_RAW2.COST]), impressions:parseNumber(v[COLS_RAW2.IMP]), clicks:parseNumber(v[COLS_RAW2.CLK]),
        conversions:parseNumber(v[COLS_RAW2.CONV]), revenue:parseNumber(v[COLS_RAW2.REV]), pos:parseNumber(v[COLS_RAW2.POS]) };
}

/* ============ ì§‘ê³„/ì§€í‘œ ============ */
function calcMetrics(arr){
    const cost=sum(arr,'cost'), imp=sum(arr,'impressions'), clk=sum(arr,'clicks'), conv=sum(arr,'conversions'), rev=sum(arr,'revenue');
    const ctr=imp>0?(clk/imp)*100:0, cpc=clk>0?cost/clk:0, cvr=clk>0?(conv/clk)*100:0, cpa=conv>0?cost/conv:0, roas=cost>0?(rev/cost)*100:0;
    const aov=conv>0?rev/conv:0, cor=rev>0?(cost/rev)*100:0;
    return {cost, impressions:imp, clicks:clk, conversions:conv, revenue:rev, ctr, cpc, cvr, cpa, roas, aov, cor};
}
function aggregate(data, keyFn){
    const map={};
    data.forEach(d=>{
        const k=keyFn(d);
        if(!map[k]) map[k]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0, sample:d, campaignType:d.campaignType, campaign:d.campaign, adgroup:d.adgroup, device:d.device, media:d.media};
        map[k].cost+=d.cost; map[k].impressions+=d.impressions; map[k].clicks+=d.clicks; map[k].conversions+=d.conversions; map[k].revenue+=d.revenue;
        map[k].campaignType = d.campaignType || map[k].campaignType;
        map[k].campaign = d.campaign || map[k].campaign;
        map[k].adgroup = d.adgroup || map[k].adgroup;
        map[k].device = d.device || map[k].device;
        map[k].media = d.media || map[k].media;
    });
    return map;
}

/* ============ ë©”ì¸ ì²˜ë¦¬ ============ */
function processData(){
    if(rawRows.length===0) return;
    weeks=[...new Set(rawRows.map(d=>d.week))].sort().reverse().slice(0,4);
    const curW=weeks[0], prevW=weeks[1];
    currentWeekData=rawRows.filter(d=>d.week===curW);
    previousWeekData=rawRows.filter(d=>d.week===prevW);
    document.getElementById('mainDateRange').textContent = weeks.length ? `${weeks[weeks.length-1]} ~ ${weeks[0]}` : '';
    populateFilters();
    initRankFilters();
    updateAll();
}
function populateFilters(){
    const types=[...new Set(rawRows.map(d=>d.campaignType||'').filter(Boolean))].sort();
    const camps=[...new Set(rawRows.map(d=>d.campaign||'').filter(Boolean))].sort();
    const adgs=[...new Set(rawRows.map(d=>d.adgroup||'').filter(Boolean))].sort();
    const setOpts=(id,arr,label)=>{ const el=document.getElementById(id); if(!el) return; el.innerHTML=`<option value="">${label}</option>`+arr.map(v=>`<option value="${v}">${v}</option>`).join(''); };
    setOpts('campaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('adgroupCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('keywordCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('mediaCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('efficiencyCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('cpcCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('deviceCampaignTypeFilter', types, 'ìº í˜ì¸ ìœ í˜• ì „ì²´');
    setOpts('adgroupCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('keywordCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('mediaCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('efficiencyCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('cpcCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('campaignCampaignFilter', camps, 'ìº í˜ì¸ ì „ì²´');
    setOpts('campaignAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('mediaAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('adgroupAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
    setOpts('keywordAdgroupFilter', adgs, 'ê´‘ê³ ê·¸ë£¹ ì „ì²´');
}
function updateAll(){
    updateStats();
    updateCampaignTable();
    updateAdgroupTable();
    updateKeywordTable(true);
    updateMediaTable();
    updateEfficiencyAnalysis();
    updateCPCAnalysis();
    updateDeviceTables();
    createCharts();
    updateStackedChart();
    updateRankTop10();
}

/* ============ ì¹´ë“œ(ì„±ê³¼ ìš”ì•½) ============ */
function renderDeltaRow(label, change, baseVal){
    const up = change>=0;
    const arrow = up ? 'â–²' : 'â–¼';
    const cls = up ? 'delta-up' : 'delta-down';
    return `<div class="delta-row"><span class="delta-label">${label} (${baseVal})</span><span class="delta-val ${cls}"><span class="delta-icon">${arrow}</span>${Math.abs(change).toFixed(1)}%</span></div>`;
}
function updateStats(){
    const cur = calcMetrics(currentWeekData);
    const prev = calcMetrics(previousWeekData);
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week));
    const four = calcMetrics(fourWeeks);
    const avg4 = {};
    const denom = weeks.length || 1;
    Object.keys(four).forEach(k=>{ avg4[k] = (typeof four[k]==='number') ? four[k]/denom : four[k]; });
    const fields = [
        {key:'cost', label:'ê´‘ê³ ë¹„'}, {key:'impressions', label:'ë…¸ì¶œìˆ˜'}, {key:'clicks', label:'í´ë¦­ìˆ˜'},
        {key:'conversions', label:'ì „í™˜ìˆ˜'}, {key:'revenue', label:'ë§¤ì¶œì•¡'}, {key:'ctr', label:'í´ë¦­ìœ¨'},
        {key:'cvr', label:'ì „í™˜ìœ¨'}, {key:'cpc', label:'CPC'}, {key:'cpa', label:'ì „í™˜ë‹¹ë¹„ìš©'},
        {key:'roas', label:'ROAS'}, {key:'aov', label:'í‰ê·  ì£¼ë¬¸ ê¸ˆì•¡'}, {key:'cor', label:'ë§¤ì¶œì•¡ ëŒ€ë¹„ ê´‘ê³ ë¹„'}
    ];
    const wrap = document.getElementById('statsContainer');
    wrap.innerHTML = fields.map(f=>{
        const curV=cur[f.key]||0, prevV=prev[f.key]||0, avgV=avg4[f.key]||0;
        const chPrev=getChangeRate(curV, prevV);
        const chAvg=getChangeRate(curV, avgV);
        return `<div class="stat-card">
            <div class="stat-title">${f.label}</div>
            <div class="stat-value-main">${formatCardValue(f.key, curV)}</div>
            <div class="delta-box">
                ${renderDeltaRow('vs ì§€ë‚œì£¼', chPrev, formatCardValue(f.key, prevV))}
                ${renderDeltaRow('vs 4ì£¼í‰ê· ', chAvg, formatCardValue(f.key, avgV))}
            </div>
        </div>`;
    }).join('');
    document.getElementById('uploadStats').innerHTML = fields.map(f=>`<div><strong>${f.label}:</strong> ${formatCardValue(f.key, cur[f.key])}</div>`).join('');
}

/* ============ ì°¨íŠ¸(4ì£¼ ì¶”ì´) ============ */
function createCharts(){
    const container=document.getElementById('overviewCharts');
    if(!weeks.length){ container.innerHTML=''; return; }
    const metricsList = [
        { key:'cost', label:'ê´‘ê³ ë¹„' }, { key:'revenue', label:'ë§¤ì¶œì•¡' }, { key:'roas', label:'ROAS' },
        { key:'clicks', label:'í´ë¦­ìˆ˜' }, { key:'conversions', label:'ì „í™˜ìˆ˜' }, { key:'cpa', label:'ì „í™˜ë‹¹ë¹„ìš©' },
        { key:'cpc', label:'CPC' }, { key:'ctr', label:'í´ë¦­ìœ¨' }, { key:'cvr', label:'ì „í™˜ìœ¨' },
        { key:'impressions', label:'ë…¸ì¶œìˆ˜' }, { key:'aov', label:'í‰ê· ì£¼ë¬¸ê¸ˆì•¡' }, { key:'cor', label:'ë§¤ì¶œì•¡ ëŒ€ë¹„ ê´‘ê³ ë¹„' }
    ];
    const labels=weeks.slice().reverse();
    const series={};
    metricsList.forEach(m=>{
        series[m.key]=labels.map(w=>calcMetrics(rawRows.filter(d=>d.week===w))[m.key]||0);
    });
    container.innerHTML = metricsList.map(m=>{
        const id='chart_'+m.key;
        const cur=series[m.key][series[m.key].length-1]||0;
        const prev=series[m.key][series[m.key].length-2]||0;
        const avg=series[m.key].reduce((a,b)=>a+b,0)/series[m.key].length;
        return `<div>
            <div class="chart-caption"><strong>${m.label}</strong> | í˜„ì¬: ${formatCardValue(m.key, cur)} / ì§€ë‚œì£¼: ${formatCardValue(m.key, prev)} / 4ì£¼í‰ê· : ${formatCardValue(m.key, avg)}</div>
            <div class="chart-wrapper"><canvas id="${id}"></canvas></div>
        </div>`;
    }).join('');
    metricsList.forEach(m=>{
        const id='chart_'+m.key; const ctx=document.getElementById(id);
        if(chartKeepers[id]){ chartKeepers[id].destroy(); delete chartKeepers[id]; }
        chartKeepers[id]=new Chart(ctx,{
            type:'line',
            data:{ labels, datasets:[{label:m.label, data:series[m.key], borderColor:'#1a7ed5', backgroundColor:'rgba(26,126,213,0.15)', tension:0.25, fill:true, pointRadius:3}] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true} } }
        });
    });
    document.getElementById('weekCompareTitle').textContent = `${labels[0]} ~ ${labels[labels.length-1]} (4ì£¼ ì¶”ì´)`;
}

/* ============ ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ (ì „ì²´ ë³´ê¸° ê¸°ë³¸) ============ */
function updateStackedChart() {
    if (currentWeekData.length === 0) return;
    const groupBy = document.getElementById('stackChartType').value;
    const limit = parseInt(document.getElementById('stackLimit').value); // 0ì´ë©´ ì „ì²´ë³´ê¸°
    const grouped = {};
    let total = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
    currentWeekData.forEach(d => {
        let key = d[groupBy] || 'ë¯¸ë¶„ë¥˜';
        if (groupBy === 'device') key = (d.device || '').includes('PC') ? 'PC' : 'ëª¨ë°”ì¼';
        if (!grouped[key]) grouped[key] = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
        grouped[key].cost += d.cost; grouped[key].impressions += d.impressions;
        grouped[key].clicks += d.clicks; grouped[key].conversions += d.conversions;
        grouped[key].revenue += d.revenue;
        total.cost += d.cost; total.impressions += d.impressions; total.clicks += d.clicks;
        total.conversions += d.conversions; total.revenue += d.revenue;
    });
    let sortedKeys = Object.keys(grouped).sort((a, b) => grouped[b].cost - grouped[a].cost);
    let finalKeys;
    if (limit === 0) {
        finalKeys = sortedKeys;
    } else {
        finalKeys = sortedKeys.slice(0, limit);
        const otherKeys = sortedKeys.slice(limit);
        if (otherKeys.length > 0) {
            grouped['ê¸°íƒ€'] = { cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
            otherKeys.forEach(k => {
                grouped['ê¸°íƒ€'].cost += grouped[k].cost; grouped['ê¸°íƒ€'].impressions += grouped[k].impressions;
                grouped['ê¸°íƒ€'].clicks += grouped[k].clicks; grouped['ê¸°íƒ€'].conversions += grouped[k].conversions;
                grouped['ê¸°íƒ€'].revenue += grouped[k].revenue;
            });
            finalKeys.push('ê¸°íƒ€');
        }
    }
    const yLabels = ['ê´‘ê³ ë¹„', 'ë…¸ì¶œìˆ˜', 'í´ë¦­ìˆ˜', 'ì „í™˜ìˆ˜', 'ë§¤ì¶œì•¡'];
    const metricKeys = ['cost', 'impressions', 'clicks', 'conversions', 'revenue'];
    
    const datasets = finalKeys.map((key, index) => {
        const data = metricKeys.map(m => total[m] > 0 ? (grouped[key][m] / total[m] * 100) : 0);
        const color = colorPalette[index % colorPalette.length];
        return {
            label: key, 
            data: data, 
            backgroundColor: color,
            borderColor: '#fff', 
            borderWidth: 1, 
            rawValues: metricKeys.map(m => grouped[key][m]),
            originalColor: color
        };
    });

    const ctx = document.getElementById('stackedBarChart').getContext('2d');
    if (stackedChartInstance) stackedChartInstance.destroy();
    
    let highlightedLabel = null;

    stackedChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: yLabels, datasets: datasets },
        options: {
            indexAxis: 'y', 
            responsive: true, 
            maintainAspectRatio: false,
            onClick: (e, activeElements, chart) => {
                if (activeElements.length > 0) {
                    const datasetIndex = activeElements[0].datasetIndex;
                    const clickedLabel = chart.data.datasets[datasetIndex].label;

                    if (highlightedLabel === clickedLabel) {
                        highlightedLabel = null;
                        chart.data.datasets.forEach(ds => ds.backgroundColor = ds.originalColor);
                    } else {
                        highlightedLabel = clickedLabel;
                        chart.data.datasets.forEach(ds => {
                            if (ds.label === clickedLabel) {
                                ds.backgroundColor = ds.originalColor;
                            } else {
                                ds.backgroundColor = '#e0e0e0';
                            }
                        });
                    }
                    chart.update();
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.dataset.label || '';
                            let val = ctx.parsed.x;
                            let raw = ctx.dataset.rawValues[ctx.dataIndex];
                            let rawStr = Math.round(raw).toLocaleString();
                            if(ctx.label==='ê´‘ê³ ë¹„'||ctx.label==='ë§¤ì¶œì•¡') rawStr+='ì›';
                            return `${label}: ${val.toFixed(1)}% (${rawStr})`;
                        }
                    }
                },
                legend: { 
                    position: 'top', 
                    labels: { boxWidth: 12, font: { size: 11 } },
                    onClick: (e, legendItem, legend) => {
                        const clickedLabel = legendItem.text;
                        const chart = legend.chart;
                        
                        if (highlightedLabel === clickedLabel) {
                            highlightedLabel = null;
                            chart.data.datasets.forEach(ds => ds.backgroundColor = ds.originalColor);
                        } else {
                            highlightedLabel = clickedLabel;
                            chart.data.datasets.forEach(ds => {
                                if (ds.label === clickedLabel) {
                                    ds.backgroundColor = ds.originalColor;
                                } else {
                                    ds.backgroundColor = '#e0e0e0';
                                }
                            });
                        }
                        chart.update();
                    }
                }
            },
            scales: { x: { stacked: true, min: 0, max: 100, ticks: { callback: v => v + '%' } }, y: { stacked: true } }
        },
        plugins: [{
            id: 'percentLabel',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                chart.data.datasets.forEach((ds, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (!meta.hidden) {
                        meta.data.forEach((el, idx) => {
                            const val = ds.data[idx];
                            if (val > 4) {
                                ctx.fillStyle = (ds.backgroundColor === '#e0e0e0') ? '#999' : '#333'; 
                                ctx.font = 'bold 11px sans-serif';
                                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                                const centerX = (el.x + el.base) / 2;
                                ctx.fillText(val.toFixed(1) + '%', centerX, el.y);
                            }
                        });
                    }
                });
            }
        }]
    });
}

/* ============ ìˆœìœ„ ë¶„ì„ ë¡œì§ ============ */
function initRankFilters() {
    const populate = (id, field, source) => {
        const el = document.getElementById(id);
        if(!el) return;
        const set = new Set(source.map(r => r[field]).filter(v => v));
        el.innerHTML = '<option value="">ì „ì²´</option>';
        Array.from(set).sort().forEach(v => el.innerHTML += `<option value="${v}">${v}</option>`);
    };
    populate('trendCT', 'campaignType', raw2Rows);
    populate('trendCamp', 'campaign', raw2Rows);
    populate('trendAdg', 'adgroup', raw2Rows);
    populate('trendMedia', 'media', raw2Rows);
    populate('heatCT', 'campaignType', rawRows);
    populate('heatCamp', 'campaign', rawRows);
    populate('heatAdg', 'adgroup', rawRows);
    populate('heatMedia', 'media', rawRows);
}
function updateRankTrend() {
    const ct = document.getElementById('trendCT').value;
    const cp = document.getElementById('trendCamp').value;
    const adg = document.getElementById('trendAdg').value;
    const med = document.getElementById('trendMedia').value;
    const inputVal = document.getElementById('trendKw').value;
    if(!inputVal.trim()) return; 
    const kws = inputVal.split(',').map(s=>s.trim()).filter(s=>s);

    const baseData = raw2Rows.filter(r => 
        (!ct || r.campaignType === ct) && 
        (!cp || r.campaign === cp) && 
        (!adg || r.adgroup === adg) &&
        (!med || r.media === med)
    );

    const dates = [...new Set(baseData.map(r=>r.day))].sort().slice(-14);
    
    const datasets = kws.map((k, i) => {
        const data = dates.map(d => {
            const target = baseData.filter(r => r.day === d && r.keyword === k && r.pos > 0);
            if(target.length === 0) return null;
            const avg = target.reduce((s,r)=>s+r.pos,0) / target.length;
            return avg;
        });
        const colors = ['#007bff','#28a745','#dc3545','#ffc107','#17a2b8', '#6610f2', '#e83e8c', '#fd7e14'];
        return { label: k, data, borderColor: colors[i % colors.length], backgroundColor: colors[i % colors.length], tension: 0.1, spanGaps: true, pointRadius: 4 };
    });

    const ctx = document.getElementById('rankTrendChart');
    if(window.trendChartObj) window.trendChartObj.destroy();
    
    window.trendChartObj = new Chart(ctx, {
        type: 'line',
        data: { labels: dates, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { reverse: true, min: 1, title: {display:true, text:'í‰ê·  ìˆœìœ„ (ìœ„)'} } },
            plugins: {
                tooltip: {
                    callbacks: { label: c => c.dataset.label + ': ' + c.parsed.y.toFixed(1) + 'ìœ„' }
                }
            }
        }
    });
}
function updateRankHeatmap() {
    const ct = document.getElementById('heatCT').value;
    const cp = document.getElementById('heatCamp').value;
    const adg = document.getElementById('heatAdg').value;
    const med = document.getElementById('heatMedia').value;

    const data = rawRows.filter(r => 
        (!ct || r.campaignType===ct) && 
        (!cp || r.campaign===cp) && 
        (!adg || r.adgroup===adg) &&
        (!med || r.media===med)
    );

    const days = ['ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼','ì¼ìš”ì¼'];
    const times = Array.from({length:24}, (_,i) => (i<10?'0'+i:i)+'ì‹œ~'+((i+1)<10?'0'+(i+1):(i+1))+'ì‹œ');
    
    const grid = {};
    data.forEach(r => {
        if(r.pos > 0 && r.dow && r.time) {
            const key = `${r.dow}_${r.time}`;
            if(!grid[key]) grid[key] = {sum:0, cnt:0};
            grid[key].sum += r.pos;
            grid[key].cnt++;
        }
    });

    let html = '<table class="rank-heatmap-table" style="width:100%; border-collapse:collapse; font-size:12px;">';
    html += '<thead><tr><th style="background:#f8f9fa; padding:8px; border:1px solid #ddd;">ì‹œê°„/ìš”ì¼</th>' + 
            days.map(d=>`<th style="background:#f8f9fa; padding:8px; border:1px solid #ddd;">${d}</th>`).join('') + 
            '</tr></thead><tbody>';
    
    times.forEach(t => {
        html += `<tr><td style="background:#eee; font-weight:bold; padding:8px; border:1px solid #ddd; text-align:center;">${t}</td>`;
        days.forEach(d => {
            const k = `${d}_${t}`;
            const cell = grid[k];
            if(cell) {
                const avg = cell.sum / cell.cnt;
                const alpha = Math.max(0.1, 1 - (avg / 15)); 
                html += `<td style="background:rgba(40,167,69,${alpha}); color:${alpha > 0.5 ? '#fff':'#333'}; padding:8px; border:1px solid #ddd; text-align:center;">${avg.toFixed(1)}ìœ„</td>`;
            } else {
                html += '<td style="padding:8px; border:1px solid #ddd; text-align:center; color:#ccc;">-</td>';
            }
        });
        html += '</tr>';
    });
    html += '</tbody></table>';
    
    document.getElementById('rankHeatmapContainer').innerHTML = html;
}

/* ============ ê³µí†µ í…Œì´ë¸”/í† ê¸€/ì†ŒíŠ¸ ============ */
function addDetailRow(colSpan, key, cur, prev, prevLabelText, avgM){
    const change=(c,p)=>badge(getChangeRate(c,p));
    const fv=(k,v)=>formatCardValue(k,v).replace('ì›','');
    const avgVal = (k) => fv(k, avgM[k]||0);
    return `<tr class="detail-row" data-parent="${key}" style="display:none">
        <td colspan="${colSpan}">
            <div style="display:flex; gap:20px; align-items:flex-start;">
                <div style="flex:1;">
                    <strong>${prevLabelText}</strong>
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;">
                        <span>ê´‘ê³ ë¹„ ${fv('cost', prev.cost||0)} (${change(cur.cost||0, prev.cost||0)})</span>
                        <span>ë…¸ì¶œ ${fv('impressions', prev.impressions||0)} (${change(cur.impressions||0, prev.impressions||0)})</span>
                        <span>í´ë¦­ ${fv('clicks', prev.clicks||0)} (${change(cur.clicks||0, prev.clicks||0)})</span>
                        <span>ì „í™˜ ${fv('conversions', prev.conversions||0)} (${change(cur.conversions||0, prev.conversions||0)})</span>
                        <span>ë§¤ì¶œ ${fv('revenue', prev.revenue||0)} (${change(cur.revenue||0, prev.revenue||0)})</span>
                        <span>ROAS ${fv('roas', prev.roas||0)} (${change(cur.roas||0, prev.roas||0)})</span>
                    </div>
                </div>
                <div style="flex:1; border-left:1px solid #ddd; padding-left:20px;">
                    <strong>4ì£¼ í‰ê· </strong>
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;">
                        <span>ê´‘ê³ ë¹„ ${avgVal('cost')}</span>
                        <span>ë…¸ì¶œ ${avgVal('impressions')}</span>
                        <span>í´ë¦­ ${avgVal('clicks')}</span>
                        <span>ì „í™˜ ${avgVal('conversions')}</span>
                        <span>ë§¤ì¶œ ${avgVal('revenue')}</span>
                        <span>ROAS ${avgVal('roas')}</span>
                    </div>
                </div>
            </div>
        </td>
    </tr>`;
}
function bindRowToggle(bodyId){
    const tbody=document.getElementById(bodyId);
    tbody.querySelectorAll('.collapsible').forEach(r=>{
        r.onclick=()=>{
            const key=r.getAttribute('data-key');
            const detail=tbody.querySelector(`tr.detail-row[data-parent="${key}"]`);
            if(detail) detail.style.display = (detail.style.display==='none'||!detail.style.display)?'table-row':'none';
        };
    });
}
function sortTable(tableId, colIdx){
    const table=document.getElementById(tableId);
    const tbody=table.querySelector('tbody');
    const totalRows=Array.from(tbody.querySelectorAll('tr.total-row, tr.prev-total-row'));
    const pairs=[]; let cur=null;
    Array.from(tbody.querySelectorAll('tr')).forEach(r=>{
        if(r.classList.contains('total-row')||r.classList.contains('prev-total-row')) return;
        if(r.classList.contains('collapsible')){ cur={row:r, detail:null}; pairs.push(cur); }
        else if(r.classList.contains('detail-row') && cur) cur.detail=r;
    });
    const asc=sortDirection[tableId+'-'+colIdx]!=='asc';
    sortDirection[tableId+'-'+colIdx]=asc?'asc':'desc';
    pairs.sort((a,b)=>{
        const getVal=row=>{
            const cell=row.cells[colIdx]; if(!cell) return '';
            const clone=cell.cloneNode(true); clone.querySelectorAll('.badge-mini').forEach(el=>el.remove());
            const t=clone.textContent.trim();
            const num=parseFloat(t.replace(/[^0-9.-]/g,'')); if(!isNaN(num)&&t.replace(/[^0-9.-]/g,'').length>0) return num;
            return t;
        };
        const av=getVal(a.row), bv=getVal(b.row);
        if(typeof av==='number' && typeof bv==='number') return asc?av-bv:bv-av;
        return asc?(''+av).localeCompare(''+bv):(''+bv).localeCompare(''+av);
    });
    tbody.innerHTML=''; totalRows.forEach(r=>tbody.appendChild(r));
    pairs.forEach(p=>{ tbody.appendChild(p.row); if(p.detail) tbody.appendChild(p.detail); });
    table.querySelectorAll('th').forEach((th,i)=>{ th.classList.remove('sort-asc','sort-desc'); if(i===colIdx) th.classList.add(asc?'sort-asc':'sort-desc'); });
    bindRowToggle(tbody.id);
}

/* ============ TOTAL í–‰ (4ì£¼ í‰ê·  ì¦ê°ë¥  ì œê±°) ============ */
function generateTotalRowHTML(list, colSpan, typeKey){
    if(!list || list.length===0) return '';
    const total=list.reduce((a,it)=>({ cost:a.cost+it.m.cost, impressions:a.impressions+it.m.impressions, clicks:a.clicks+it.m.clicks, conversions:a.conversions+it.m.conversions, revenue:a.revenue+it.m.revenue }), {cost:0, impressions:0, clicks:0, conversions:0, revenue:0});
    const cur=calcMetrics([total]);
    const prevTotal=list.reduce((a,it)=>({ cost:a.cost+it.pm.cost, impressions:a.impressions+it.pm.impressions, clicks:a.clicks+it.pm.clicks, conversions:a.conversions+it.pm.conversions, revenue:a.revenue+it.pm.revenue }), {cost:0, impressions:0, clicks:0, conversions:0, revenue:0});
    const prev=calcMetrics([prevTotal]);
    const fourWeeks=rawRows.filter(d=>weeks.includes(d.week));
    const avg4=calcMetrics(fourWeeks);
    const denom = weeks.length || 1;
    ['cost','impressions','clicks','conversions','revenue'].forEach(k=>{ avg4[k]= (avg4[k]||0)/denom; });
    avg4.ctr = avg4.impressions>0 ? (avg4.clicks/avg4.impressions)*100 : 0;
    avg4.cpc = avg4.clicks>0 ? avg4.cost/avg4.clicks : 0;
    avg4.cvr = avg4.clicks>0 ? (avg4.conversions/avg4.clicks)*100 : 0;
    avg4.cpa = avg4.conversions>0 ? avg4.cost/avg4.conversions : 0;
    avg4.roas = avg4.cost>0 ? (avg4.revenue/avg4.cost)*100 : 0;

    const keys=['cost','impressions','clicks','ctr','cpc','conversions','cvr','revenue','cpa','roas'];
    const val=(k,m,p)=>`<td class="number">${formatCardValue(k,m[k])} <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`;
    const valNoBadge=(k,m)=>`<td class="number">${formatCardValue(k,m[k])}</td>`;
    const prevCells=keys.map(k=>`<td class="number">${formatCardValue(k, prev[k]||0)}</td>`).join('');
    const curCells =keys.map(k=>val(k, cur, prev)).join('');
    const avgCells =keys.map(k=>valNoBadge(k, avg4)).join('');
    const labelColSpan=(typeKey==='adgroup')?4:(typeKey==='keyword'?4:3);
    const prevLabel=weeks[1]?`TOTAL (${weeks[1]} Week)`:'TOTAL (Previous Week)';
    const curLabel =weeks[0]?`TOTAL (${weeks[0]} Week)`:'TOTAL (Latest Week)';
    const avgLabel ='TOTAL (4 Weeks Avg)';
    return `
        <tr class="total-row sticky-total-row row-0" style="background:#dff1ff;"><td colspan="${labelColSpan}" style="text-align:center;">${avgLabel}</td>${avgCells}</tr>
        <tr class="prev-total-row sticky-total-row row-1" style="background:#fff3cd;"><td colspan="${labelColSpan}" style="text-align:center;">${prevLabel}</td>${prevCells}</tr>
        <tr class="total-row sticky-total-row row-2" style="background:#d4edda;"><td colspan="${labelColSpan}" style="text-align:center;">${curLabel}</td>${curCells}</tr>
    `;
}

/* ============ ìº í˜ì¸/ê´‘ê³ ê·¸ë£¹/í‚¤ì›Œë“œ/ë§¤ì²´ ============ */
function campaignRowCells(it){
    const m=it.m,p=it.pm;
    return [
        ['cost'],['impressions'],['clicks'],['ctr'],['cpc'],['conversions'],['cvr'],['revenue'],['cpa'],['roas']
    ].map(([k])=>`<td class="number">${formatCardValue(k,m[k])} <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`).join('');
}
function updateCampaignTable(){
    const tbody=document.getElementById('campaignBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const filter=(document.getElementById('campaignFilter').value||'').toLowerCase();
    const typeFilter=document.getElementById('campaignTypeFilter').value;
    const deviceFilter=document.getElementById('campaignDeviceFilter').value;
    const campFilter=document.getElementById('campaignCampaignFilter').value;
    const agFilter=document.getElementById('campaignAdgroupFilter').value;
    
    const dataFiltered = currentWeekData.filter(d=>{
        return (!typeFilter||d.campaignType===typeFilter) &&
               (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
               (!campFilter||d.campaign===campFilter) &&
               (!agFilter||d.adgroup===agFilter);
    });
    const prevFiltered = previousWeekData.filter(d=>{
        return (!typeFilter||d.campaignType===typeFilter) &&
               (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
               (!campFilter||d.campaign===campFilter) &&
               (!agFilter||d.adgroup===agFilter);
    });

    const curMap=aggregate(dataFiltered, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(prevFiltered, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week) &&
        (!typeFilter||d.campaignType===typeFilter) &&
        (!deviceFilter|| (d.device||'').includes(deviceFilter)) &&
        (!campFilter||d.campaign===campFilter) &&
        (!agFilter||d.adgroup===agFilter)
    );
    const avgMap = aggregate(fourWeeks, d=>d.campaign||'ë¯¸ë¶„ë¥˜');
    const denom = weeks.length || 1;

    const list=Object.keys(curMap).map(k=>{
        const m=calcMetrics([curMap[k]]); 
        const pm=prevMap[k]?calcMetrics([prevMap[k]]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,roas:0};
        if(avgMap[k]) {
            ['cost','impressions','clicks','conversions','revenue'].forEach(key => avgM[key] = avgMap[k][key]/denom);
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        const type=curMap[k].campaignType||'-';
        if(k.toLowerCase().indexOf(filter)===-1) return null;
        return {name:k,type,m,pm,avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);

    let html=generateTotalRowHTML(list,13,'campaign');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.name}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.name}">${it.name}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            ${campaignRowCells(it)}
        </tr>`;
        html+=addDetailRow(13,it.name,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="13" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('campaignBody'); clearROASFilter('campaignBody');
}

function adgroupRowCells(it){
    const m=it.m,p=it.pm;
    return [
        ['cost'],['impressions'],['clicks'],['ctr'],['cpc'],['conversions'],['cvr'],['revenue'],['cpa'],['roas']
    ].map(([k])=>`<td class="number">${formatCardValue(k,m[k])} <span class="badge-mini">${badge(getChangeRate(m[k], p[k]||0))}</span></td>`).join('');
}
function updateAdgroupTable(){
    const tbody=document.getElementById('adgroupBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const f=(document.getElementById('adgroupFilter').value||'').toLowerCase();
    const campF=document.getElementById('adgroupCampaignFilter').value;
    const typeF=document.getElementById('adgroupCampaignTypeFilter').value;
    const devF=document.getElementById('adgroupDeviceFilter').value;
    const keyFn=d=>`${d.campaign||'ë¯¸ë¶„ë¥˜'}||${d.adgroup||'ë¯¸ë¶„ë¥˜'}`;
    const cur=aggregate(currentWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const prev=aggregate(previousWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const fourWeeks = rawRows.filter(d=>weeks.includes(d.week) &&
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!devF||(d.device||'').includes(devF))
    );
    const avgMap = aggregate(fourWeeks, keyFn);
    const denom = weeks.length || 1;

    const list=Object.keys(cur).map(k=>{
        const [camp,ag]=k.split('||'); const type=cur[k].campaignType||'-';
        if(f && ag.toLowerCase().indexOf(f)===-1) return null;
        const m=calcMetrics([cur[k]]); 
        const pm=prev[k]?calcMetrics([prev[k]]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,roas:0};
        if(avgMap[k]) {
            ['cost','impressions','clicks','conversions','revenue'].forEach(key => avgM[key] = avgMap[k][key]/denom);
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        return {camp,ag,type,m,pm,avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);
    let html=generateTotalRowHTML(list,14,'adgroup');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.camp}||${it.ag}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.ag}">${it.ag}</td>
            <td class="text-col" title="${it.camp}">${it.camp}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            ${adgroupRowCells(it)}
        </tr>`;
        html+=addDetailRow(14,`${it.camp}||${it.ag}`,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="14" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('adgroupBody'); clearROASFilter('adgroupBody');
}

function updateKeywordTable(reset){
    if(reset) keywordPage=1;
    const tbody=document.getElementById('keywordBody');
    if(!raw2Rows.length){ tbody.innerHTML='<tr><td colspan="14" class="no-data">RAW2(ê²€ìƒ‰ì–´) íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const search=(document.getElementById('keywordSearch').value||'').toLowerCase();
    const device=document.getElementById('deviceFilter').value;
    const campF=document.getElementById('keywordCampaignFilter').value;
    const typeF=document.getElementById('keywordCampaignTypeFilter').value;
    const agF=document.getElementById('keywordAdgroupFilter').value;
    const filterFn = d => (!device || (d.device||'').includes(device))
            && (!campF || d.campaign===campF)
            && (!typeF || d.campaignType===typeF)
            && (!agF || d.adgroup===agF);

    const curData = raw2Rows.filter(d => d.week===weeks[0] && filterFn(d));
    const prevData = raw2Rows.filter(d => d.week===weeks[1] && filterFn(d));
    const curMap=aggregate(curData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(prevData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');

    const fourWeeks = raw2Rows.filter(d=>weeks.includes(d.week) && filterFn(d));
    const avgMap = aggregate(fourWeeks, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const denom = weeks.length || 1;

    const rows=Object.keys(curMap).map(k=>{
        if(k.toLowerCase().indexOf(search)===-1) return null;
        const m=calcMetrics([{...curMap[k]}]);
        const pm=prevMap[k]?calcMetrics([{...prevMap[k]}]):calcMetrics([]);
        let avgM = {cost:0,impressions:0,clicks:0,conversions:0,revenue:0,ctr:0,cvr:0,cpa:0,roas:0,cpc:0};
        if(avgMap[k]) {
            avgM.cost = avgMap[k].cost/denom;
            avgM.impressions = avgMap[k].impressions/denom;
            avgM.clicks = avgMap[k].clicks/denom;
            avgM.conversions = avgMap[k].conversions/denom;
            avgM.revenue = avgMap[k].revenue/denom;
            avgM.ctr = avgM.impressions>0 ? (avgM.clicks/avgM.impressions)*100 : 0;
            avgM.cpc = avgM.clicks>0 ? avgM.cost/avgM.clicks : 0;
            avgM.cvr = avgM.clicks>0 ? (avgM.conversions/avgM.clicks)*100 : 0;
            avgM.cpa = avgM.conversions>0 ? avgM.cost/avgM.conversions : 0;
            avgM.roas = avgM.cost>0 ? (avgM.revenue/avgM.cost)*100 : 0;
        }
        return {keyword:k, data:curMap[k].sample, m, pm, avgM};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);

    const totalPages=Math.max(1, Math.ceil(rows.length/PAGE_SIZE));
    keywordPage=Math.min(keywordPage,totalPages);
    const start=(keywordPage-1)*PAGE_SIZE;
    const pageRows=rows.slice(start,start+PAGE_SIZE);
    let html=generateTotalRowHTML(rows,14,'keyword');
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    pageRows.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.keyword}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${start+idx+1}</span></td>
            <td class="text-col" title="${it.keyword}"><strong>${it.keyword}</strong></td>
            <td class="text-col" title="${it.data.campaign}">${it.data.campaign}</td>
            <td class="text-col" title="${it.data.adgroup}">${it.data.adgroup}</td>
            <td class="number">${formatCardValue('cost', it.m.cost)} <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
            <td class="number">${formatCardValue('impressions', it.m.impressions)} <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
            <td class="number">${formatCardValue('clicks', it.m.clicks)} <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
            <td class="number">${formatCardValue('ctr', it.m.ctr)} <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
            <td class="number">${formatCardValue('cpc', it.m.cpc)} <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
            <td class="number">${formatCardValue('conversions', it.m.conversions)} <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
            <td class="number">${formatCardValue('cvr', it.m.cvr)} <span class="badge-mini">${badge(getChangeRate(it.m.cvr, it.pm.cvr||0))}</span></td>
            <td class="number">${formatCardValue('revenue', it.m.revenue)} <span class="badge-mini">${badge(getChangeRate(it.m.revenue, it.pm.revenue||0))}</span></td>
            <td class="number">${formatCardValue('cpa', it.m.cpa)} <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
            <td class="number" style="color:#111; font-weight:bold;">${formatCardValue('roas', it.m.roas)} <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
        </tr>`;
        html+=addDetailRow(14,it.keyword,it.m,it.pm,prevLabel,it.avgM);
    });
    tbody.innerHTML = html || '<tr><td colspan="14" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    document.getElementById('kwPageInfo').textContent = `${rows.length===0?0:keywordPage} / ${rows.length===0?0:totalPages}`;
    document.getElementById('kwPrev').disabled = keywordPage<=1;
    document.getElementById('kwNext').disabled = keywordPage>=totalPages;
    bindRowToggle('keywordBody'); clearROASFilter('keywordBody');
}
function changeKeywordPage(d){ keywordPage+=d; if(keywordPage<1) keywordPage=1; updateKeywordTable(false); }

function updateMediaTable(){
    const tbody=document.getElementById('mediaBody');
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="16" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const search=(document.getElementById('mediaFilter').value||'').toLowerCase();
    const campF=document.getElementById('mediaCampaignFilter').value;
    const typeF=document.getElementById('mediaCampaignTypeFilter').value;
    const agF=document.getElementById('mediaAdgroupFilter').value;
    const devF=document.getElementById('mediaDeviceFilter').value;
    const keyFn=d=>`${d.media||'ë¯¸ë¶„ë¥˜'}||${d.campaign||'ë¯¸ë¶„ë¥˜'}||${d.adgroup||'ë¯¸ë¶„ë¥˜'}||${d.campaignType||'ë¯¸ë¶„ë¥˜'}||${d.device||''}`;
    const cur=aggregate(currentWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!agF||d.adgroup===agF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const prev=aggregate(previousWeekData.filter(d=>
        (!campF||d.campaign===campF)&&(!typeF||d.campaignType===typeF)&&(!agF||d.adgroup===agF)&&(!devF||(d.device||'').includes(devF))
    ), keyFn);
    const list=Object.keys(cur).map(k=>{
        const [media,camp,ag,type,device]=k.split('||');
        if(media.toLowerCase().indexOf(search)===-1) return null;
        const m=calcMetrics([cur[k]]); const pm=prev[k]?calcMetrics([prev[k]]):calcMetrics([]);
        return {media,camp,ag,type,device,m,pm};
    }).filter(Boolean).sort((a,b)=>b.m.conversions-a.m.conversions);
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    let html='';
    list.forEach((it,idx)=>{
        html+=`<tr class="collapsible" data-key="${it.media}||${it.camp}||${it.device}" data-roas="${it.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${it.media}">${it.media}</td>
            <td class="text-col" title="${it.camp}">${it.camp}</td>
            <td class="text-col" title="${it.ag}">${it.ag}</td>
            <td class="text-col" title="${it.device}">${it.device}</td>
            <td class="text-col" title="${it.type}">${it.type}</td>
            <td class="number">${formatCardValue('cost', it.m.cost)} <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
            <td class="number">${formatCardValue('impressions', it.m.impressions)} <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
            <td class="number">${formatCardValue('clicks', it.m.clicks)} <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
            <td class="number">${formatCardValue('ctr', it.m.ctr)} <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
            <td class="number">${formatCardValue('cpc', it.m.cpc)} <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
            <td class="number">${formatCardValue('conversions', it.m.conversions)} <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
            <td class="number">${formatCardValue('cvr', it.m.cvr)} <span class="badge-mini">${badge(getChangeRate(it.m.cvr, it.pm.cvr||0))}</span></td>
            <td class="number">${formatCardValue('revenue', it.m.revenue)} <span class="badge-mini">${badge(getChangeRate(it.m.revenue, it.pm.revenue||0))}</span></td>
            <td class="number">${formatCardValue('cpa', it.m.cpa)} <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
            <td class="number" style="color:#111;">${formatCardValue('roas', it.m.roas)} <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
        </tr>`;
        html+=addDetailRow(16,`${it.media}||${it.camp}||${it.device}`,it.m,it.pm,prevLabel,it.m); // avg not used here
    });
    tbody.innerHTML = html || '<tr><td colspan="16" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle('mediaBody'); clearROASFilter('mediaBody');
}

/* ============ íš¨ìœ¨ ============ */
function updateEfficiencyAnalysis(){
    const brandEx=(document.getElementById('brandExclude').value||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const typeF=document.getElementById('efficiencyCampaignTypeFilter').value;
    const campF=document.getElementById('efficiencyCampaignFilter').value;
    const agF=document.getElementById('efficiencyAdgroupFilter').value;
    const costMin=+document.getElementById('filterCostMin').value;
    const convMin=+document.getElementById('filterConvMin').value;
    const roasMin=+document.getElementById('filterROASMin').value;
    const cpaMin=+document.getElementById('filterCPAMin').value;
    const curData=raw2Rows.filter(d=>weeks.includes(d.week) && (!typeF||d.campaignType===typeF) && (!campF||d.campaign===campF) && (!agF||d.adgroup===agF));
    const curMap=aggregate(curData, d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(raw2Rows.filter(d=>d.week===weeks[1]), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const good=[], bad=[];
    Object.keys(curMap).forEach(k=>{
        if(brandEx.some(ex=>ex && k.toLowerCase().includes(ex))) return;
        const m=calcMetrics([{...curMap[k]}]);
        const pm=prevMap[k]?calcMetrics([{...prevMap[k]}]):calcMetrics([]);
        let ok=true;
        if(!isNaN(costMin)&&m.cost<costMin) ok=false;
        if(!isNaN(convMin)&&m.conversions<convMin) ok=false;
        if(!isNaN(roasMin)&&m.roas<roasMin) ok=false;
        if(!isNaN(cpaMin)&&m.cpa<cpaMin) ok=false;
        const row={keyword:k, data:curMap[k].sample, m, pm};
        if(ok) good.push(row); else bad.push(row);
    });
    const render=(arr, bodyId)=>{
        const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
        const allZero=arr.length>0 && arr.every(x=>x.m.conversions===0);
        const sorted=arr.sort((a,b)=> allZero ? b.m.cost-a.m.cost : b.m.conversions-a.m.conversions);
        const html=sorted.map((it,idx)=>`
            <tr class="collapsible" data-key="${bodyId}_${it.keyword}">
                <td><span class="rank-badge">${idx+1}</span></td>
                <td class="text-col" title="${it.data.campaignType}">${it.data.campaignType||'-'}</td>
                <td class="text-col" title="${it.keyword}"><strong>${it.keyword}</strong></td>
                <td class="text-col" title="${it.data.campaign}">${it.data.campaign}</td>
                <td class="text-col" title="${it.data.adgroup}">${it.data.adgroup}</td>
                <td class="number">${formatCardValue('cost', it.m.cost)} <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
                <td class="number">${formatCardValue('impressions', it.m.impressions)} <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
                <td class="number">${formatCardValue('clicks', it.m.clicks)} <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
                <td class="number">${formatCardValue('ctr', it.m.ctr)} <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
                <td class="number">${formatCardValue('cpc', it.m.cpc)} <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
                <td class="number">${formatCardValue('conversions', it.m.conversions)} <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
                <td class="number">${formatCardValue('cpa', it.m.cpa)} <span class="badge-mini">${badge(getChangeRate(it.m.cpa, it.pm.cpa||0))}</span></td>
                <td class="number" style="color:#111;">${formatCardValue('roas', it.m.roas)} <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
            </tr>
            ${addDetailRow(13, `${bodyId}_${it.keyword}`, it.m, it.pm, prevLabel, it.m)}
        `).join('') || '<tr><td colspan="13" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>';
        document.getElementById(bodyId).innerHTML = html;
        bindRowToggle(bodyId);
    };
    render(good,'goodEfficiencyBody');
    render(bad,'badEfficiencyBody');
}

/* ============ CPC ============ */
function updateCPCAnalysis(){
    const brandEx=(document.getElementById('cpcBrandExclude').value||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
    const typeF=document.getElementById('cpcCampaignTypeFilter').value;
    const campF=document.getElementById('cpcCampaignFilter').value;
    const agF=document.getElementById('cpcAdgroupFilter').value;
    const costMin=+document.getElementById('cpcCostMin').value;
    const convMin=+document.getElementById('cpcConvMin').value;
    const roasMin=+document.getElementById('cpcROASMin').value;
    const cpaMin=+document.getElementById('cpcCPAMin').value;
    const th=+document.getElementById('cpcChangeThreshold').value || 0;
    const totalCost=sum(raw2Rows.filter(d=>weeks.includes(d.week)),'cost');
    const curMap=aggregate(raw2Rows.filter(d=>{
        return weeks.includes(d.week) && (!typeF||d.campaignType===typeF) && (!campF||d.campaign===campF) && (!agF||d.adgroup===agF);
    }), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const prevMap=aggregate(raw2Rows.filter(d=>d.week===weeks[1]), d=>d.keyword||'ë¯¸ë¶„ë¥˜');
    const up=[], down=[];
    Object.keys(curMap).forEach(k=>{
        if(brandEx.some(ex=>ex && k.toLowerCase().includes(ex))) return;
        const cur=calcMetrics([{...curMap[k]}]);
        const prev=prevMap[k]?calcMetrics([{...prevMap[k]}]):{cpc:0,cost:0,clicks:0,conversions:0,roas:0,impressions:0,ctr:0,revenue:0};
        if(cur.cost===0) return;
        if(!isNaN(costMin)&&cur.cost<costMin) return;
        if(!isNaN(convMin)&&cur.conversions<convMin) return;
        if(!isNaN(roasMin)&&cur.roas<roasMin) return;
        if(!isNaN(cpaMin)&&cur.cpa<cpaMin) return;
        const change=prev.cpc===0?100:((cur.cpc-prev.cpc)/prev.cpc*100);
        const costShare= totalCost>0 ? (cur.cost/totalCost*100) : 0;
        const row={keyword:k, data:curMap[k].sample, m:cur, pm:prev, change, costShare};
        if(change>=th) up.push(row);
        else if(change<=-th) down.push(row);
    });
    const render=(arr, bodyId, isUp)=>{
        const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
        const sorted=isUp ? arr.sort((a,b)=>b.change-a.change) : arr.sort((a,b)=>a.change-b.change);
        const html=sorted.map((r,idx)=>`
            <tr class="collapsible" data-key="${bodyId}_${r.keyword}">
                <td><span class="rank-badge">${idx+1}</span></td>
                <td class="text-col" title="${r.data.campaignType}">${r.data.campaignType||'-'}</td>
                <td class="text-col" title="${r.keyword}"><strong>${r.keyword}</strong></td>
                <td class="text-col" title="${r.data.campaign}">${r.data.campaign}</td>
                <td class="text-col" title="${r.data.adgroup}">${r.data.adgroup}</td>
                <td class="number">${formatCardValue('cpc', r.m.cpc)} <span class="badge-mini">${badge(getChangeRate(r.m.cpc, r.pm.cpc||0))}</span></td>
                <td class="number">${r.change.toFixed(2)}%</td>
                <td class="number">${formatCardValue('cost', r.m.cost)} <span class="badge-mini">${badge(getChangeRate(r.m.cost, r.pm.cost||0))}</span></td>
                <td class="number">${r.costShare.toFixed(2)}%</td>
                <td class="number">${formatCardValue('impressions', r.m.impressions)} <span class="badge-mini">${badge(getChangeRate(r.m.impressions, r.pm.impressions||0))}</span></td>
                <td class="number">${formatCardValue('clicks', r.m.clicks)} <span class="badge-mini">${badge(getChangeRate(r.m.clicks, r.pm.clicks||0))}</span></td>
                <td class="number">${formatCardValue('ctr', r.m.ctr)} <span class="badge-mini">${badge(getChangeRate(r.m.ctr, r.pm.ctr||0))}</span></td>
                <td class="number">${formatCardValue('conversions', r.m.conversions)} <span class="badge-mini">${badge(getChangeRate(r.m.conversions, r.pm.conversions||0))}</span></td>
                <td class="number">${formatCardValue('revenue', r.m.revenue)} <span class="badge-mini">${badge(getChangeRate(r.m.revenue, r.pm.revenue||0))}</span></td>
                <td class="number" style="color:#111;">${formatCardValue('roas', r.m.roas)} <span class="badge-mini">${badge(getChangeRate(r.m.roas, r.pm.roas||0))}</span></td>
            </tr>
            ${addDetailRow(14, `${bodyId}_${r.keyword}`, r.m, r.pm, prevLabel, r.m)}
        `).join('') || '<tr><td colspan="15" class="no-data">ë°ì´í„° ì—†ìŒ</td></tr>';
        document.getElementById(bodyId).innerHTML = html;
        bindRowToggle(bodyId);
    };
    render(up,'cpcUpBody',true);
    render(down,'cpcDownBody',false);
}

/* ============ ë””ë°”ì´ìŠ¤ ============ */
function updateDeviceTables(){
    const std=+document.getElementById('standardROAS3').value;
    const typeF=document.getElementById('deviceCampaignTypeFilter').value;
    const prevLabel=weeks[1]?`${weeks[1]} ì§€ë‚œ ë°ì´í„°`:'ì§€ë‚œ ë°ì´í„°';
    updateDeviceSide('devicePCBody','PC',std,typeF,prevLabel);
    updateDeviceSide('deviceMOBody','MO',std,typeF,prevLabel);
    clearROASFilter('devicePCBody'); clearROASFilter('deviceMOBody');
}
function updateDeviceSide(bodyId, deviceLabel, std, typeF, prevLabel){
    const tbody=document.getElementById(bodyId);
    if(!currentWeekData.length){ tbody.innerHTML='<tr><td colspan="11" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
    const curMap={}, prevMap={}; let totalCost=0;
    currentWeekData.forEach(d=>{
        if(typeF && d.campaignType!==typeF) return;
        const dev=(d.device||'').includes('PC')?'PC':'MO'; if(dev!==deviceLabel) return;
        const camp=d.campaign||'ë¯¸ë¶„ë¥˜';
        if(!curMap[camp]) curMap[camp]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0};
        curMap[camp].cost+=d.cost; curMap[camp].impressions+=d.impressions; curMap[camp].clicks+=d.clicks; curMap[camp].conversions+=d.conversions; curMap[camp].revenue+=d.revenue;
        totalCost+=d.cost;
    });
    previousWeekData.forEach(d=>{
        if(typeF && d.campaignType!==typeF) return;
        const dev=(d.device||'').includes('PC')?'PC':'MO'; if(dev!==deviceLabel) return;
        const camp=d.campaign||'ë¯¸ë¶„ë¥˜';
        if(!prevMap[camp]) prevMap[camp]={cost:0, impressions:0, clicks:0, conversions:0, revenue:0};
        prevMap[camp].cost+=d.cost; prevMap[camp].impressions+=d.impressions; prevMap[camp].clicks+=d.clicks; prevMap[camp].conversions+=d.conversions; prevMap[camp].revenue+=d.revenue;
    });
    const rows=Object.keys(curMap).map(camp=>{
        const m=calcMetrics([curMap[camp]]); const pm=prevMap[camp]?calcMetrics([prevMap[camp]]):calcMetrics([]);
        const costShare= totalCost>0 ? (curMap[camp].cost/totalCost*100):0;
        return {camp, costShare, m, pm};
    }).sort((a,b)=>b.m.cost-a.m.cost);
    let html='';
    rows.forEach((r,idx)=>{
        html+=`<tr class="collapsible" data-key="${bodyId}_${r.camp}" data-roas="${r.m.roas}">
            <td><span class="rank-badge">${idx+1}</span></td>
            <td class="text-col" title="${r.camp}">${r.camp}</td>
            <td class="number">${formatCardValue('cost', r.m.cost)}</td>
            <td class="number">${r.costShare.toFixed(1)}%</td>
            <td class="number">${formatCardValue('impressions', r.m.impressions)}</td>
            <td class="number">${formatCardValue('clicks', r.m.clicks)}</td>
            <td class="number">${formatCardValue('conversions', r.m.conversions)} <span class="badge-mini">${badge(getChangeRate(r.m.conversions, r.pm.conversions||0))}</span></td>
            <td class="number">${formatCardValue('revenue', r.m.revenue)}</td>
            <td class="number">${formatCardValue('cpa', r.m.cpa)}</td>
            <td class="number" style="color:#111;">${formatCardValue('roas', r.m.roas)}</td>
            <td class="number">${badge(getChangeRate(r.m.roas, r.pm.roas||0))}</td>
        </tr>`;
        html+=addDetailRow(11, `${bodyId}_${r.camp}`, r.m, r.pm, prevLabel, r.m);
    });
    tbody.innerHTML = html || '<tr><td colspan="11" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    bindRowToggle(bodyId);
}
function applyROASFilterDevice(direction){
    const std=+document.getElementById('standardROAS3').value;
    ['devicePCBody','deviceMOBody'].forEach(id=>{
        const tbody=document.getElementById(id);
        if(isNaN(std)) return;
        tbody.querySelectorAll('tr.collapsible').forEach(tr=>{
            const roas=parseFloat(tr.getAttribute('data-roas'));
            tr.classList.toggle('low-roas', direction==='low' ? roas<std : (direction==='up'? roas<std : roas>std));
        });
    });
}
function resetDevice(){ document.getElementById('deviceCampaignTypeFilter').value=''; document.getElementById('standardROAS3').value=''; updateDeviceTables(); }

/* ë¦¬ì…‹ë“¤ */
function resetCampaign(){ document.getElementById('campaignFilter').value=''; document.getElementById('campaignTypeFilter').value=''; document.getElementById('campaignDeviceFilter').value=''; document.getElementById('campaignCampaignFilter').value=''; document.getElementById('campaignAdgroupFilter').value=''; document.getElementById('standardROAS').value=''; clearROASFilter('campaignBody'); updateCampaignTable(); }
function resetAdgroup(){ document.getElementById('adgroupFilter').value=''; document.getElementById('adgroupCampaignFilter').value=''; document.getElementById('adgroupCampaignTypeFilter').value=''; document.getElementById('adgroupDeviceFilter').value=''; document.getElementById('standardROAS_AG').value=''; clearROASFilter('adgroupBody'); updateAdgroupTable(); }
function resetKeyword(){ document.getElementById('keywordSearch').value=''; document.getElementById('deviceFilter').value=''; document.getElementById('keywordCampaignFilter').value=''; document.getElementById('keywordCampaignTypeFilter').value=''; document.getElementById('keywordAdgroupFilter').value=''; document.getElementById('standardROAS2').value=''; clearROASFilter('keywordBody'); keywordPage = 1; updateKeywordTable(true); }
function resetMedia(){ document.getElementById('mediaFilter').value=''; document.getElementById('mediaCampaignFilter').value=''; document.getElementById('mediaCampaignTypeFilter').value=''; document.getElementById('mediaAdgroupFilter').value=''; document.getElementById('mediaDeviceFilter').value=''; document.getElementById('standardROAS_MEDIA').value=''; clearROASFilter('mediaBody'); updateMediaTable(); }
function resetEfficiency(){ document.getElementById('brandExclude').value=''; document.getElementById('efficiencyCampaignTypeFilter').value=''; document.getElementById('efficiencyCampaignFilter').value=''; document.getElementById('efficiencyAdgroupFilter').value=''; document.getElementById('filterCostMin').value=''; document.getElementById('filterConvMin').value=''; document.getElementById('filterROASMin').value=''; document.getElementById('filterCPAMin').value=''; updateEfficiencyAnalysis(); }
function resetCPC(){ document.getElementById('cpcBrandExclude').value=''; document.getElementById('cpcCampaignTypeFilter').value=''; document.getElementById('cpcCampaignFilter').value=''; document.getElementById('cpcAdgroupFilter').value=''; document.getElementById('cpcCostMin').value=''; document.getElementById('cpcConvMin').value=''; document.getElementById('cpcROASMin').value=''; document.getElementById('cpcCPAMin').value=''; document.getElementById('cpcChangeThreshold').value=''; updateCPCAnalysis(); }
function resetCreative(){ document.getElementById('creativeProductSearch').value=''; document.getElementById('creativeCampaignFilter').value=''; document.getElementById('creativeAdgroupFilter').value=''; updateCreativeTable(); }

/* ============ Creative Analysis ============ */
function updateCreativeTable(){
    const tbody = document.getElementById('creativeBody');
    if(creativeRows.length === 0 || Object.keys(productMap).length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="no-data">Creative ë° Product íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>';
        return;
    }
    
    const search = (document.getElementById('creativeProductSearch').value || '').toLowerCase();
    const campFilter = document.getElementById('creativeCampaignFilter').value;
    const agFilter = document.getElementById('creativeAdgroupFilter').value;
    
    // Get date ranges
    const allDates = [...new Set(creativeRows.map(d=>d.date))].sort().reverse();
    const curDates = allDates.slice(0, 7);
    const preDates = allDates.slice(7, 14);
    
    // Aggregate by material
    const agg = {};
    creativeRows.forEach(r => {
        if(campFilter && r.campaign !== campFilter) return;
        if(agFilter && r.adgroup !== agFilter) return;
        
        const matId = r.material;
        if(!agg[matId]) {
            agg[matId] = {
                campaign: r.campaign,
                adgroup: r.adgroup,
                material: matId,
                cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0,
                pCost: 0, pImpressions: 0, pClicks: 0, pConversions: 0, pRevenue: 0
            };
        }
        
        if(curDates.includes(r.date)) {
            agg[matId].cost += r.cost;
            agg[matId].impressions += r.impressions;
            agg[matId].clicks += r.clicks;
            agg[matId].conversions += r.conversions;
            agg[matId].revenue += r.revenue;
        }
        if(preDates.includes(r.date)) {
            agg[matId].pCost += r.cost;
            agg[matId].pImpressions += r.impressions;
            agg[matId].pClicks += r.clicks;
            agg[matId].pConversions += r.conversions;
            agg[matId].pRevenue += r.revenue;
        }
    });
    
    // Convert to array with calculated metrics
    const list = Object.values(agg).map(r => {
        const product = productMap[r.material] || { name: 'ë§¤ì¹­ ì‹¤íŒ¨', image: '' };
        const productName = product.name;
        
        // Filter by product name
        if(search && productName.toLowerCase().indexOf(search) === -1) return null;
        
        const m = calcMetrics([r]);
        const pm = calcMetrics([{
            cost: r.pCost,
            impressions: r.pImpressions,
            clicks: r.pClicks,
            conversions: r.pConversions,
            revenue: r.pRevenue
        }]);
        
        return {
            campaign: r.campaign,
            adgroup: r.adgroup,
            material: r.material,
            productName,
            image: product.image,
            m, pm
        };
    }).filter(Boolean).sort((a,b) => b.m.conversions - a.m.conversions);
    
    // Render table
    let html = list.map((it, idx) => {
        const imgSrc = it.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E';
        // Escape HTML to prevent XSS
        const escapedCampaign = escapeHtml(it.campaign);
        const escapedAdgroup = escapeHtml(it.adgroup);
        const escapedProductName = escapeHtml(it.productName);
        const escapedImgSrc = escapeHtml(imgSrc);
        return `<tr>
            <td><span class="rank-badge">${idx+1}</span></td>
            <td><img src="${escapedImgSrc}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E'"></td>
            <td class="text-col" title="${escapedCampaign}">${escapedCampaign}</td>
            <td class="text-col" title="${escapedAdgroup}">${escapedAdgroup}</td>
            <td style="text-align:left; max-width:250px; overflow:hidden; text-overflow:ellipsis;" title="${escapedProductName}">${escapedProductName}</td>
            <td class="number">${formatCardValue('cost', it.m.cost)} <span class="badge-mini">${badge(getChangeRate(it.m.cost, it.pm.cost||0))}</span></td>
            <td class="number">${formatCardValue('impressions', it.m.impressions)} <span class="badge-mini">${badge(getChangeRate(it.m.impressions, it.pm.impressions||0))}</span></td>
            <td class="number">${formatCardValue('clicks', it.m.clicks)} <span class="badge-mini">${badge(getChangeRate(it.m.clicks, it.pm.clicks||0))}</span></td>
            <td class="number">${formatCardValue('ctr', it.m.ctr)} <span class="badge-mini">${badge(getChangeRate(it.m.ctr, it.pm.ctr||0))}</span></td>
            <td class="number">${formatCardValue('cpc', it.m.cpc)} <span class="badge-mini">${badge(getChangeRate(it.m.cpc, it.pm.cpc||0))}</span></td>
            <td class="number">${formatCardValue('conversions', it.m.conversions)} <span class="badge-mini">${badge(getChangeRate(it.m.conversions, it.pm.conversions||0))}</span></td>
            <td class="number">${formatCardValue('revenue', it.m.revenue)} <span class="badge-mini">${badge(getChangeRate(it.m.revenue, it.pm.revenue||0))}</span></td>
            <td class="number" style="color:#111; font-weight:bold;">${formatCardValue('roas', it.m.roas)} <span class="badge-mini">${badge(getChangeRate(it.m.roas, it.pm.roas||0))}</span></td>
        </tr>`;
    }).join('') || '<tr><td colspan="13" class="no-data">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    
    tbody.innerHTML = html;
    
    // Populate filters if not yet populated
    if(document.getElementById('creativeCampaignFilter').options.length === 1){
        const campaigns = [...new Set(creativeRows.map(r=>r.campaign))].sort();
        campaigns.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            document.getElementById('creativeCampaignFilter').appendChild(opt);
        });
        
        const adgroups = [...new Set(creativeRows.map(r=>r.adgroup))].sort();
        adgroups.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a;
            opt.textContent = a;
            document.getElementById('creativeAdgroupFilter').appendChild(opt);
        });
    }
}

/* ============ TOP 10 Search Terms ============ */
function updateRankTop10() {
    if(raw2Rows.length === 0) return;
    
    // Aggregate by keyword
    const keywordMap = {};
    raw2Rows.forEach(r => {
        const kw = r.keyword || 'ë¯¸ë¶„ë¥˜';
        if(!keywordMap[kw]) {
            keywordMap[kw] = { keyword: kw, cost: 0, impressions: 0, clicks: 0, conversions: 0, revenue: 0 };
        }
        keywordMap[kw].cost += r.cost;
        keywordMap[kw].impressions += r.impressions;
        keywordMap[kw].clicks += r.clicks;
        keywordMap[kw].conversions += r.conversions;
        keywordMap[kw].revenue += r.revenue;
    });
    
    const keywords = Object.values(keywordMap);
    
    // Create 5 TOP 10 tables
    const tables = [
        { title: 'ğŸ’° ê´‘ê³ ë¹„ TOP 10', field: 'cost', formatter: v => formatMoney(v) + 'ì›' },
        { title: 'ğŸ‘ï¸ ë…¸ì¶œìˆ˜ TOP 10', field: 'impressions', formatter: formatNum },
        { title: 'ğŸ–±ï¸ í´ë¦­ìˆ˜ TOP 10', field: 'clicks', formatter: formatNum },
        { title: 'ğŸ¯ ì „í™˜ìˆ˜ TOP 10', field: 'conversions', formatter: formatNum },
        { title: 'ğŸ’µ ë§¤ì¶œì•¡ TOP 10', field: 'revenue', formatter: v => formatMoney(v) + 'ì›' }
    ];
    
    const container = document.getElementById('top10Container');
    let html = '';
    
    tables.forEach(table => {
        const sorted = [...keywords].sort((a, b) => b[table.field] - a[table.field]).slice(0, 10);
        html += `
            <div class="top10-table-wrapper">
                <div class="top10-title">${table.title}</div>
                <table class="top10-table">
                    <tbody>
                        ${sorted.map((kw, idx) => {
                            const escapedKeyword = escapeHtml(kw.keyword);
                            return `
                            <tr>
                                <td>${idx + 1}</td>
                                <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapedKeyword}">${escapedKeyword}</td>
                                <td>${table.formatter(kw[table.field])}</td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

/* ============ Drag and Drop for file upload ============ */
function initDragAndDrop() {
    const zones = ['Raw', 'Raw2', 'Creative', 'Product'];
    zones.forEach(zone => {
        const dropZone = document.getElementById('dropZone' + zone);
        if(!dropZone) return;
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if(files.length > 0) {
                const inputId = 'fileInput' + zone;
                const input = document.getElementById(inputId);
                if(input) {
                    try {
                        // Create a new DataTransfer to assign files
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        input.files = dataTransfer.files;
                        input.dispatchEvent(new Event('change'));
                    } catch(e) {
                        // Fallback for older browsers: trigger click to open file dialog
                        console.warn('DataTransfer not supported, please click to upload');
                        input.click();
                    }
                }
            }
        });
    });
}

// Initialize drag and drop on page load
document.addEventListener('DOMContentLoaded', () => {
    initDragAndDrop();
});

</script>
</body>
</html>