<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (4ì£¼)</title>

  <!-- Dependencies (kept) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Added for ì‡¼í•‘-ìƒí’ˆ ë¶„ì„ (from ì†Œì¬.html) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <style>
    /* === ORIGINAL STYLES (kept as-is as much as possible) === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 2200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 15px; }
    .header-title-group { display: flex; align-items: baseline; gap: 15px; }
    .header h1 { font-size: 32px; color: #333; font-weight: bold; }
    .header-date { font-size: 14px; color: #666; font-weight: normal; background: #f0f0f0; padding: 4px 10px; border-radius: 12px; }

    .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
    .nav-tabs button { padding: 12px 16px; border: none; background: none; cursor: pointer; font-size: 14px; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
    .nav-tabs button:hover { color: #007bff; }
    .nav-tabs button.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .section { margin-bottom: 50px; }
    .section-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; display:flex; justify-content: space-between; align-items: center; }

    .controls { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .controls input, .controls select, .controls button { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; height: 36px; }
    .controls select { max-width: 160px; }
    .controls button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; white-space: nowrap; }
    .controls button:hover { background-color: #0056b3; }
    .controls button.danger { background-color: #dc3545; }
    .controls button.danger:hover { background-color: #c82333; }
    .controls button.secondary { background: #6c757d; color: #fff; }
    .controls button.secondary:hover { background: #5a6268; }
    .controls button.btn-compact { padding: 8px 8px; font-size: 11px; letter-spacing: -0.5px; }

    .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 13px; }
    .status { padding: 15px; border-radius: 4px; margin-top: 15px; display: none; font-weight: bold; }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    .table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; max-height: 700px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto; }
    th { padding: 10px 6px; text-align: left; font-weight: bold; color: white; background: #007bff; border-bottom: 2px solid #0056b3; white-space: nowrap; position: sticky; top: 0; cursor: pointer; z-index: 2; }
    td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: left; }
    th:hover { background: #0056b3; }
    th.sort-asc::after { content: ' â–²'; }
    th.sort-desc::after { content: ' â–¼'; }
    td.number, th.number { white-space: nowrap; }
    .text-col { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    tr:hover { background: #f9f9f9; }
    tr.filtered-out { display: none !important; }
    tr.low-roas { background-color: #ffecec !important; }
    tr.total-row, tr.prev-total-row { background-color: #e3f2fd !important; font-weight: bold; border-bottom: 2px solid #bbdefb; }
    tr.total-row td, tr.prev-total-row td { color: #0d47a1; }
    tr.total-row:hover, tr.prev-total-row:hover { background-color: #bbdefb !important; }
    .no-data { text-align: center; padding: 40px 20px; color: #999; font-size: 16px; }

    .detail-row { background: #f7fbff; }
    .detail-row td div { display: flex; flex-wrap: nowrap; gap: 12px; align-items: center; width: 100%; padding: 6px 4px; font-size: 11px; color: #444; white-space: nowrap; }
    .detail-row strong { margin-right: 8px; color: #333; font-size: 12px; min-width: 80px; }
    .badge-mini { font-size: 11px; color: #666; margin-left: 4px; white-space: nowrap; }
    .hide-changes .badge-mini { display: none !important; }

    .pagination { display: flex; gap: 8px; align-items: center; font-size: 12px; margin: 10px 0; }
    .pagination button { padding: 6px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    .chart-container { background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 30px; border: 1px solid #ddd; }
    .chart-wrapper { position: relative; height: 220px; width: 100%; }
    .chart-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 20px; row-gap: 32px; }
    .chart-caption { font-size: 12px; color: #444; margin-bottom: 4px; }
    .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(520px, 1fr)); gap: 16px; }

    .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
    .stat-card { background: #f9fafb; border: 1px solid #e3e6ea; border-radius: 8px; padding: 16px; min-height: 140px; display: flex; flex-direction: column; gap: 12px; }
    .stat-title { font-size: 13px; font-weight: 700; color: #444; }
    .stat-value-main { font-size: 28px; font-weight: 800; color: #111; }
    .delta-box { background: #fff; border: 1px solid #e3e6ea; border-radius: 6px; padding: 10px 12px; display: flex; flex-direction: column; gap: 8px; }
    .delta-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #444; }
    .delta-label { color: #444; }
    .delta-val { font-weight: 700; }
    .delta-up { color: #2e8b57; }
    .delta-down { color: #c0392b; }
    .delta-icon { margin-right: 6px; font-weight: 900; }

    .rank-heatmap-table th, .rank-heatmap-table td { text-align: center; border: 1px solid #eee; padding: 8px; font-size: 11px; }
    .rank-heatmap-table th { background: #f8f9fa; font-weight: bold; }

    /* === NEW: Upload drag-and-drop UI (keep style language) === */
    .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .dropzone { border: 2px dashed #cfd8dc; background: #fafbfc; border-radius: 8px; padding: 14px; min-height: 90px; display:flex; flex-direction: column; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
    .dropzone:hover { border-color: #007bff; background: #f3f8ff; }
    .dropzone.dragover { border-color: #007bff; background: #e7f3ff; }
    .dropzone-title { display:flex; justify-content: space-between; align-items:center; font-weight: 800; color:#333; font-size: 13px; }
    .dropzone-desc { color:#666; font-size: 12px; line-height: 1.4; }
    .upload-check { display:inline-flex; align-items:center; justify-content:center; width: 22px; height: 22px; border-radius: 50%; border: 2px solid #cfd8dc; color:#cfd8dc; font-weight: 900; font-size: 13px; }
    .dropzone.done { border-color: #2e8b57; background: #f1fbf4; }
    .dropzone.done .upload-check { border-color:#2e8b57; color:#2e8b57; }
    .dropzone input[type=file] { display:none; }

    /* === NEW: Rank top10 sticky bar === */
    .rank-top10-sticky { position: sticky; top: 0; z-index: 5; background: #fff; padding: 10px 0 12px; border-bottom: 1px solid #eee; }
    .rank-top10-grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; }
    .rank-mini-table { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; }
    .rank-mini-title { background: #007bff; color: #fff; font-weight: 800; padding: 8px 10px; font-size: 12px; }
    .rank-mini-table table { width:100%; border-collapse: collapse; font-size: 11px; }
    .rank-mini-table th, .rank-mini-table td { padding: 6px 8px; border-bottom: 1px solid #eee; text-align:left; white-space: nowrap; }
    .rank-mini-table th { position: static; background: #f8f9fa; color:#333; border-bottom: 1px solid #eee; cursor: default; }

    /* === NEW: ì‡¼í•‘-ìƒí’ˆ ë¶„ì„ (adapting ì†Œì¬.html to existing style language) === */
    .shop-container { background: #fff; }
    .shop-upload { display:flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; padding: 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 14px; }
    .shop-upload .file-input-group { display:flex; flex-direction: column; font-size: 12px; font-weight: 700; gap: 6px; }
    .shop-upload .file-input-group input { height: 36px; }

    .shop-filter-section { display:flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; border-bottom: 1px solid #eee; align-items: center; }
    .shop-card { min-width: 120px; padding: 10px 15px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; flex-shrink: 0; }
    .shop-card.active { border: 2px solid #007bff; background: #f3f8ff; font-weight: 800; }
    .shop-card:hover { background: #f9f9f9; }
    .shop-reset-btn { padding: 8px 18px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 12px; flex-shrink: 0; }
    .shop-reset-btn:hover { background: #c82333; }

    .shop-table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; max-height: 700px; overflow-y: auto; }
    .shop-table { width: 100%; border-collapse: collapse; min-width: 1600px; font-size: 12px; }
    .shop-table th { background: #007bff; color: #fff; padding: 10px 6px; cursor:pointer; position: sticky; top:0; z-index:2; border-bottom: 2px solid #0056b3; text-align:left; }
    .shop-table td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align:left; white-space: nowrap; }
    .shop-col-campaign, .shop-col-adgroup { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .shop-col-product { max-width: 340px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .shop-diff { font-size: 11px; color: #666; margin-left: 6px; }
    .shop-up { color: #2e8b57; }
    .shop-down { color: #c0392b; }

    .shop-detail { margin-top: 18px; padding: 18px; border: 1px solid #ddd; border-radius: 12px; display:none; background: #fff; }
    .shop-tab-area { display:flex; gap: 8px; margin-top: 18px; margin-bottom: 14px; flex-wrap: wrap; }
    .shop-tab-btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #fff; cursor: pointer; font-size: 12px; transition: 0.2s; }
    .shop-tab-btn.active { background: #007bff; color: #fff; border-color:#007bff; }
    .shop-tab-btn:hover { background: #f0f0f0; }

    .shop-chart-grid { display:flex; flex-direction: column; gap: 16px; }
    .shop-chart-container { border: 1px solid #ddd; padding: 14px; border-radius: 8px; background: #f9f9f9; }
    .shop-chart-box { height: 320px; background: #fff; padding: 10px; border-radius: 6px; }

    .shop-stats-row { display:flex; gap: 12px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; justify-content: space-around; }
    .shop-stat-item { text-align:center; flex:1; border-right: 1px solid #eee; }
    .shop-stat-item:last-child { border-right: none; }
    .shop-stat-label { font-size: 11px; color:#666; margin-bottom:4px; }
    .shop-stat-value { font-size: 14px; font-weight: 800; color:#2c3e50; }
    .shop-stat-value.max { color:#2e8b57; }
    .shop-stat-value.min { color:#c0392b; }

    .img-thumb { width: 46px; height: 46px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
    .badge-group { background: #dc3545; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 6px; }

    canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-title-group">
      <h1>ğŸ“Š ë§ˆì¼€íŒ… ì„±ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ (ìµœê·¼ 4ì£¼)</h1>
      <span id="mainDateRange" class="header-date"></span>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab(event, 'upload')">ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ</button>
    <button class="tab-btn" onclick="switchTab(event, 'overview')">ğŸ“ˆ ì„±ê³¼ ìš”ì•½</button>
    <button class="tab-btn" onclick="switchTab(event, 'rank')">ğŸ† ìˆœìœ„ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'campaign')">ğŸ¯ ìº í˜ì¸ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'adgroup')">ğŸ§© ê´‘ê³ ê·¸ë£¹ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'keyword')">ğŸ” í‚¤ì›Œë“œ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'media')">ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'efficiency')">âš¡ íš¨ìœ¨ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'cpc')">ğŸ’² CPC ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'device')">ğŸ“± ë””ë°”ì´ìŠ¤ ë¶„ì„</button>
    <button class="tab-btn" onclick="switchTab(event, 'shopProduct')">ğŸ›ï¸ ì‡¼í•‘-ìƒí’ˆ ë¶„ì„</button>
  </div>

  <!-- TAB 1: Upload (modified: drag-drop + remove stats summary) -->
  <div id="upload" class="tab-content active">
    <div class="section" id="section-upload">
      <div class="section-title"><span>ğŸ“¤ ë°ì´í„° ì—…ë¡œë“œ</span></div>
      <div class="info-box">
        ğŸ’¡ ì•„ë˜ 4ê°œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>
        â€¢ RAW: ì¼ë³„/ì£¼ë³„, ì‹œê°„ëŒ€/ìš”ì¼ í¬í•¨ (CSV/XLSX)<br>
        â€¢ ê²€ìƒ‰ì–´(RAW2): ê²€ìƒ‰ì–´ í¬í•¨ (CSV/XLSX)<br>
        â€¢ ì†Œì¬(CSV): ì‡¼í•‘ê²€ìƒ‰ ì†Œì¬/ì„±ê³¼ ë³´ê³ ì„œ (CSV)
        â€¢ ìƒí’ˆTSV: ì‡¼í•‘ ìƒí’ˆ ì •ë³´ (TSV)
      </div>

      <div class="upload-grid">
        <div class="dropzone" id="dzRaw" onclick="document.getElementById('fileInputRaw').click()">
          <div class="dropzone-title"><span>RAW (ì¼/ì£¼ë³„)</span><span class="upload-check" id="chkRaw">âœ“</span></div>
          <div class="dropzone-desc">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”. (csv/xlsx)</div>
          <input type="file" id="fileInputRaw" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw')" />
        </div>

        <div class="dropzone" id="dzRaw2" onclick="document.getElementById('fileInputRaw2').click()">
          <div class="dropzone-title"><span>ê²€ìƒ‰ì–´ (RAW2)</span><span class="upload-check" id="chkRaw2">âœ“</span></div>
          <div class="dropzone-desc">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”. (csv/xlsx)</div>
          <input type="file" id="fileInputRaw2" accept=".csv,.xlsx,.xls" onchange="handleUpload(event, 'raw2')" />
        </div>

        <div class="dropzone" id="dzShopCsv" onclick="document.getElementById('fileInputShopCsv').click()">
          <div class="dropzone-title"><span>ì†Œì¬ (ì‡¼í•‘ CSV)</span><span class="upload-check" id="chkShopCsv">âœ“</span></div>
          <div class="dropzone-desc">ì‡¼í•‘ê²€ìƒ‰ ì„±ê³¼ ë³´ê³ ì„œ CSV (EUC-KR ê°€ëŠ¥)</div>
          <input type="file" id="fileInputShopCsv" accept=".csv" onchange="handleUpload(event, 'shopCsv')" />
        </div>

        <div class="dropzone" id="dzShopTsv" onclick="document.getElementById('fileInputShopTsv').click()">
          <div class="dropzone-title"><span>ìƒí’ˆTSV</span><span class="upload-check" id="chkShopTsv">âœ“</span></div>
          <div class="dropzone-desc">ìƒí’ˆ ì •ë³´ TSV (íƒ­ êµ¬ë¶„)</div>
          <input type="file" id="fileInputShopTsv" accept=".tsv" onchange="handleUpload(event, 'shopTsv')" />
        </div>
      </div>

      <div id="uploadStatus" class="status"></div>
    </div>
  </div>

  <!-- TAB 2: Overview (kept placeholder; original script must handle) -->
  <div id="overview" class="tab-content"><div class="section" id="section-overview"><div class="section-title"><span>ğŸ“ˆ ì„±ê³¼ ìš”ì•½</span></div><div id="statsContainer" class="stat-grid"></div><div class="chart-container"><h3 id="weekCompareTitle" style="margin-bottom: 16px;">ì£¼ê°„ ì„±ê³¼ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h3><div class="chart-grid" id="overviewCharts"></div></div><div class="chart-container" style="margin-top: 30px;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><h3 style="margin: 0;">ğŸ“Š í•­ëª©ë³„ ì„±ê³¼ ë¹„ì¤‘ ë¶„ì„ (100%)</h3><div class="controls" style="margin: 0;"><select id="stackChartType" onchange="updateStackedChart()"><option value="campaignType">ìº í˜ì¸ ìœ í˜•ë³„</option><option value="campaign" selected>ìº í˜ì¸ë³„</option><option value="adgroup">ê´‘ê³ ê·¸ë£¹ë³„</option><option value="device">ë””ë°”ì´ìŠ¤ë³„</option></select><select id="stackLimit" onchange="updateStackedChart()"><option value="0" selected>ì „ì²´ ë³´ê¸°</option><option value="5">ìƒìœ„ 5ê°œ</option><option value="10">ìƒìœ„ 10ê°œ</option><option value="20">ìƒìœ„ 20ê°œ</option></select></div></div><div class="chart-wrapper" style="height: 400px;"><canvas id="stackedBarChart"></canvas></div><p style="font-size:12px; color:#666; text-align:right; margin-top:5px;">* ì°¨íŠ¸ì˜ ë§‰ëŒ€ë‚˜ ë²”ë¡€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í•­ëª©ì´ ê°•ì¡°ë©ë‹ˆë‹¤.</p></div></div></div>

  <!-- TAB: Rank (modified: add sticky TOP10 tables, keep existing content below) -->
  <div id="rank" class="tab-content">
    <div class="section">
      <div class="section-title"><span>ğŸ† ìˆœìœ„ ë¶„ì„</span></div>

      <div class="rank-top10-sticky">
        <div class="rank-top10-grid" id="rankTop10Grid">
          <!-- filled by JS -->
        </div>
      </div>

      <div class="rank-panel" style="margin-bottom:20px; background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
        <h3 style="font-size: 18px;">ğŸ“‰ ê²€ìƒ‰ì–´ë³„ ìˆœìœ„ ì¶”ì´ (ìµœê·¼ 14ì¼)</h3>
        <div class="controls" style="margin-top:10px;">
          <select id="trendCT" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
          <select id="trendCamp" onchange="updateRankTrend()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
          <select id="trendAdg" onchange="updateRankTrend()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
          <select id="trendMedia" onchange="updateRankTrend()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
          <input type="text" id="trendKw" placeholder="ê²€ìƒ‰ì–´ (ì‰¼í‘œë¡œ êµ¬ë¶„: í‚¤ì›Œë“œ1, í‚¤ì›Œë“œ2)" style="width:300px;" onchange="updateRankTrend()" />
          <button onclick="updateRankTrend()">ì¡°íšŒ</button>
        </div>
        <div style="height:350px;"><canvas id="rankTrendChart"></canvas></div>
      </div>

      <div class="rank-panel" style="background:#fff; border:1px solid #ddd; padding:20px; border-radius:8px;">
        <h3 style="font-size: 18px;">â° ì‹œê°„ëŒ€/ìš”ì¼ë³„ í‰ê·  ìˆœìœ„ (Heatmap)</h3>
        <div class="controls" style="margin-top:10px;">
          <select id="heatCT" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
          <select id="heatCamp" onchange="updateRankHeatmap()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
          <select id="heatAdg" onchange="updateRankHeatmap()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
          <select id="heatMedia" onchange="updateRankHeatmap()"><option value="">ë§¤ì²´ ì „ì²´</option></select>
          <button onclick="updateRankHeatmap()">ë¶„ì„</button>
        </div>
        <div id="rankHeatmapContainer" style="overflow-x:auto; margin-top:15px;">
          <p style="padding:20px; text-align:center; color:#999;">ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  'ë¶„ì„' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìˆœìœ„í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 3: Campaign (modified controls: remove campaign type, change search to ìƒí’ˆëª… ê²€ìƒ‰) -->
  <div id="campaign" class="tab-content">
    <div class="section" id="section-campaign">
      <div class="section-title"><span>ğŸ¯ ìº í˜ì¸ ì„±ê³¼ ë¶„ì„</span></div>
      <div class="controls">
        <input class="text-col" type="text" id="campaignFilter" placeholder="ìƒí’ˆëª… ê²€ìƒ‰" onkeyup="updateCampaignTable()" />
        <select id="campaignDeviceFilter" onchange="updateCampaignTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
        <select id="campaignCampaignFilter" onchange="updateCampaignTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
        <select id="campaignAdgroupFilter" onchange="updateCampaignTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
        <input type="number" id="standardROAS" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10" />
        <button onclick="highlightLowROAS('campaignBody', 'standardROAS')">ROAS ì ìš©</button>
        <button class="filter-red" onclick="filterRedRows('campaignBody')">í•„í„°ë§</button>
        <button class="roas-up" onclick="applyROASFilter('campaignBody', 'up', 'standardROAS')">â†‘</button>
        <button class="roas-down" onclick="applyROASFilter('campaignBody', 'down', 'standardROAS')">â†“</button>
        <button class="danger" onclick="resetCampaign()">ì´ˆê¸°í™”</button>
        <button class="secondary" onclick="toggleChangeBadge('campaignTable')">ì¦ê°ìœ¨ On/Off</button>
      </div>
      <div class="table-wrapper">
        <table id="campaignTable">
          <thead>
            <tr>
              <th onclick="sortTable('campaignTable', 0)">ìˆœìœ„</th>
              <th onclick="sortTable('campaignTable', 1)">ìº í˜ì¸</th>
              <th onclick="sortTable('campaignTable', 2)" class="number">ê´‘ê³ ë¹„</th>
              <th onclick="sortTable('campaignTable', 3)" class="number">ë…¸ì¶œìˆ˜</th>
              <th onclick="sortTable('campaignTable', 4)" class="number">í´ë¦­ìˆ˜</th>
              <th onclick="sortTable('campaignTable', 5)" class="number">í´ë¦­ìœ¨</th>
              <th onclick="sortTable('campaignTable', 6)" class="number">CPC</th>
              <th onclick="sortTable('campaignTable', 7)" class="number">ì „í™˜ìˆ˜</th>
              <th onclick="sortTable('campaignTable', 8)" class="number">ì „í™˜ìœ¨</th>
              <th onclick="sortTable('campaignTable', 9)" class="number">ë§¤ì¶œì•¡</th>
              <th onclick="sortTable('campaignTable', 10)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
              <th onclick="sortTable('campaignTable', 11)" class="number">ROAS</th>
            </tr>
          </thead>
          <tbody id="campaignBody"><tr><td colspan="12" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 4: Adgroup (kept layout; TOTAL ordering handled in JS) -->
  <div id="adgroup" class="tab-content">
    <div class="section" id="section-adgroup">
      <div class="section-title"><span>ğŸ§© ê´‘ê³ ê·¸ë£¹ ì„±ê³¼ ë¶„ì„</span></div>
      <div class="controls">
        <input class="text-col" type="text" id="adgroupFilter" placeholder="ê´‘ê³ ê·¸ë£¹ ê²€ìƒ‰" onkeyup="updateAdgroupTable()" />
        <select id="adgroupCampaignFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
        <select id="adgroupCampaignTypeFilter" onchange="updateAdgroupTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
        <select id="adgroupDeviceFilter" onchange="updateAdgroupTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
        <input type="number" id="standardROAS_AG" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10" />
        <button onclick="highlightLowROAS('adgroupBody', 'standardROAS_AG')">ROAS ì ìš©</button>
        <button class="filter-red" onclick="filterRedRows('adgroupBody')">í•„í„°ë§</button>
        <button class="roas-up" onclick="applyROASFilter('adgroupBody', 'up', 'standardROAS_AG')">â†‘</button>
        <button class="roas-down" onclick="applyROASFilter('adgroupBody', 'down', 'standardROAS_AG')">â†“</button>
        <button class="danger" onclick="resetAdgroup()">ì´ˆê¸°í™”</button>
        <button class="secondary" onclick="toggleChangeBadge('adgroupTable')">ì¦ê°ìœ¨ On/Off</button>
      </div>
      <div class="table-wrapper">
        <table id="adgroupTable">
          <thead>
            <tr>
              <th onclick="sortTable('adgroupTable', 0)">ìˆœìœ„</th>
              <th onclick="sortTable('adgroupTable', 1)">ê´‘ê³ ê·¸ë£¹</th>
              <th onclick="sortTable('adgroupTable', 2)">ìº í˜ì¸</th>
              <th onclick="sortTable('adgroupTable', 3)">ìº í˜ì¸ìœ í˜•</th>
              <th onclick="sortTable('adgroupTable', 4)" class="number">ê´‘ê³ ë¹„</th>
              <th onclick="sortTable('adgroupTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
              <th onclick="sortTable('adgroupTable', 6)" class="number">í´ë¦­ìˆ˜</th>
              <th onclick="sortTable('adgroupTable', 7)" class="number">í´ë¦­ìœ¨</th>
              <th onclick="sortTable('adgroupTable', 8)" class="number">CPC</th>
              <th onclick="sortTable('adgroupTable', 9)" class="number">ì „í™˜ìˆ˜</th>
              <th onclick="sortTable('adgroupTable', 10)" class="number">ì „í™˜ìœ¨</th>
              <th onclick="sortTable('adgroupTable', 11)" class="number">ë§¤ì¶œì•¡</th>
              <th onclick="sortTable('adgroupTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
              <th onclick="sortTable('adgroupTable', 13)" class="number">ROAS</th>
            </tr>
          </thead>
          <tbody id="adgroupBody"><tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 5: Keyword (data source must be RAW2; ROAS diff in table; TOTAL ordering in JS) -->
  <div id="keyword" class="tab-content">
    <div class="section" id="section-keyword">
      <div class="section-title"><span>ğŸ” í‚¤ì›Œë“œ ì„±ê³¼ ë¶„ì„</span></div>
      <div class="controls">
        <input class="text-col" type="text" id="keywordSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰" onkeyup="updateKeywordTable(true)" />
        <select id="keywordCampaignTypeFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select>
        <select id="keywordCampaignFilter" onchange="updateKeywordTable(true)"><option value="">ìº í˜ì¸ ì „ì²´</option></select>
        <select id="keywordAdgroupFilter" onchange="updateKeywordTable(true)"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select>
        <select id="deviceFilter" onchange="updateKeywordTable(true)"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select>
        <input type="number" id="standardROAS2" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10" />
        <button onclick="highlightLowROAS('keywordBody', 'standardROAS2')">ROAS ì ìš©</button>
        <button class="filter-red" onclick="filterRedRows('keywordBody')">í•„í„°ë§</button>
        <button class="roas-up" onclick="applyROASFilter('keywordBody', 'up', 'standardROAS2')">â†‘</button>
        <button class="roas-down" onclick="applyROASFilter('keywordBody', 'down', 'standardROAS2')">â†“</button>
        <button class="danger" onclick="resetKeyword()">ì´ˆê¸°í™”</button>
        <button class="secondary" onclick="toggleChangeBadge('keywordTable')">ì¦ê°ìœ¨ On/Off</button>
      </div>
      <div class="pagination">
        <button id="kwPrev" onclick="changeKeywordPage(-1)">ì´ì „</button>
        <span id="kwPageInfo">0 / 0</span>
        <button id="kwNext" onclick="changeKeywordPage(1)">ë‹¤ìŒ</button>
      </div>
      <div class="table-wrapper">
        <table id="keywordTable">
          <thead>
            <tr>
              <th onclick="sortTable('keywordTable', 0)">ìˆœìœ„</th>
              <th onclick="sortTable('keywordTable', 1)">ê²€ìƒ‰ì–´</th>
              <th onclick="sortTable('keywordTable', 2)">ìº í˜ì¸</th>
              <th onclick="sortTable('keywordTable', 3)">ê´‘ê³ ê·¸ë£¹</th>
              <th onclick="sortTable('keywordTable', 4)" class="number">ê´‘ê³ ë¹„</th>
              <th onclick="sortTable('keywordTable', 5)" class="number">ë…¸ì¶œìˆ˜</th>
              <th onclick="sortTable('keywordTable', 6)" class="number">í´ë¦­ìˆ˜</th>
              <th onclick="sortTable('keywordTable', 7)" class="number">í´ë¦­ìœ¨</th>
              <th onclick="sortTable('keywordTable', 8)" class="number">CPC</th>
              <th onclick="sortTable('keywordTable', 9)" class="number">ì „í™˜ìˆ˜</th>
              <th onclick="sortTable('keywordTable', 10)" class="number">ì „í™˜ìœ¨</th>
              <th onclick="sortTable('keywordTable', 11)" class="number">ë§¤ì¶œì•¡</th>
              <th onclick="sortTable('keywordTable', 12)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th>
              <th onclick="sortTable('keywordTable', 13)" class="number">ROAS</th>
            </tr>
          </thead>
          <tbody id="keywordBody"><tr><td colspan="14" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 6: Media (kept placeholder; original script must handle) -->
  <div id="media" class="tab-content"><div class="section" id="section-media"><div class="section-title"><span>ğŸ“° ë§¤ì²´ë³„ ë¶„ì„</span></div><div class="controls"><input class="text-col" type="text" id="mediaFilter" placeholder="ë§¤ì²´ ê²€ìƒ‰" onkeyup="updateMediaTable()"><select id="mediaCampaignTypeFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select><select id="mediaCampaignFilter" onchange="updateMediaTable()"><option value="">ìº í˜ì¸ ì „ì²´</option></select><select id="mediaAdgroupFilter" onchange="updateMediaTable()"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select><select id="mediaDeviceFilter" onchange="updateMediaTable()"><option value="">ì „ì²´ ë””ë°”ì´ìŠ¤</option><option value="PC">PC</option><option value="ëª¨ë°”ì¼">ëª¨ë°”ì¼</option></select><input type="number" id="standardROAS_MEDIA" placeholder="ROAS ê¸°ì¤€ %" min="0" step="10"><button onclick="highlightLowROAS('mediaBody', 'standardROAS_MEDIA')">ROAS ì ìš©</button><button class="filter-red" onclick="filterRedRows('mediaBody')">í•„í„°ë§</button><button class="roas-up" onclick="applyROASFilter('mediaBody', 'up', 'standardROAS_MEDIA')">â†‘</button><button class="roas-down" onclick="applyROASFilter('mediaBody', 'down', 'standardROAS_MEDIA')">â†“</button><button class="danger" onclick="resetMedia()">ì´ˆê¸°í™”</button><button class="secondary" onclick="toggleChangeBadge('mediaTable')">ì¦ê°ìœ¨ On/Off</button></div><div class="table-wrapper"><table id="mediaTable"><thead><tr><th onclick="sortTable('mediaTable', 0)">ìˆœìœ„</th><th onclick="sortTable('mediaTable', 1)">ë§¤ì²´</th><th onclick="sortTable('mediaTable', 2)">ìº í˜ì¸</th><th onclick="sortTable('mediaTable', 3)">ê´‘ê³ ê·¸ë£¹</th><th onclick="sortTable('mediaTable', 4)">ë””ë°”ì´ìŠ¤</th><th onclick="sortTable('mediaTable', 5)">ìº í˜ì¸ìœ í˜•</th><th onclick="sortTable('mediaTable', 6)" class="number">ê´‘ê³ ë¹„</th><th onclick="sortTable('mediaTable', 7)" class="number">ë…¸ì¶œìˆ˜</th><th onclick="sortTable('mediaTable', 8)" class="number">í´ë¦­ìˆ˜</th><th onclick="sortTable('mediaTable', 9)" class="number">í´ë¦­ìœ¨</th><th onclick="sortTable('mediaTable', 10)" class="number">CPC</th><th onclick="sortTable('mediaTable', 11)" class="number">ì „í™˜ìˆ˜</th><th onclick="sortTable('mediaTable', 12)" class="number">ì „í™˜ìœ¨</th><th onclick="sortTable('mediaTable', 13)" class="number">ë§¤ì¶œì•¡</th><th onclick="sortTable('mediaTable', 14)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th><th onclick="sortTable('mediaTable', 15)" class="number">ROAS</th></tr></thead><tbody id="mediaBody"><tr><td colspan="16" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody></table></div></div></div>

  <!-- TAB 7: Efficiency (kept placeholder; original script must handle) -->
  <div id="efficiency" class="tab-content"><div class="section" id="section-efficiency"><div class="section-title"><span>âš¡ íš¨ìœ¨ë¶„ì„</span></div><div class="info-box">ğŸ’¡ í•„í„°ë§ ì¡°ê±´(ìµœì†Œ ê´‘ê³ ë¹„, ìµœì†Œ ì „í™˜ìˆ˜ ë“±)ì„ ëª¨ë‘ ë§Œì¡±í•˜ë©´ íš¨ìœ¨ GOOD, ì•„ë‹ˆë©´ BAD.</div><div class="controls"><input class="text-col" type="text" id="brandExclude" placeholder="ì œì™¸ í‚¤ì›Œë“œ(ì½¤ë§ˆ)"><select id="efficiencyCampaignTypeFilter"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select><select id="efficiencyCampaignFilter"><option value="">ìº í˜ì¸ ì „ì²´</option></select><select id="efficiencyAdgroupFilter"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select><input type="number" id="filterCostMin" placeholder="ìµœì†Œ ê´‘ê³ ë¹„"><input type="number" id="filterConvMin" placeholder="ìµœì†Œ ì „í™˜ìˆ˜"><input type="number" id="filterROASMin" placeholder="ìµœì†Œ ROAS"><input type="number" id="filterCPAMin" placeholder="ìµœì†Œ ì „í™˜ë‹¹ë¹„ìš©"><button onclick="updateEfficiencyAnalysis()">ğŸ” ì ìš©</button><button class="danger" onclick="resetEfficiency()">ì´ˆê¸°í™”</button><button class="secondary btn-compact" onclick="toggleChangeBadge('goodEfficiencyTable'); toggleChangeBadge('badEfficiencyTable');">ì¦ê°ìœ¨ On/Off</button></div><h3 style="margin: 20px 0 10px; color: #333;">âœ… íš¨ìœ¨ GOOD (í•„í„° ì¶©ì¡±)</h3><div class="table-wrapper"><table id="goodEfficiencyTable"><thead><tr><th onclick="sortTable('goodEfficiencyTable',0)">ìˆœìœ„</th><th onclick="sortTable('goodEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th><th onclick="sortTable('goodEfficiencyTable',2)">ê²€ìƒ‰ì–´</th><th onclick="sortTable('goodEfficiencyTable',3)">ìº í˜ì¸</th><th onclick="sortTable('goodEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th><th onclick="sortTable('goodEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th><th onclick="sortTable('goodEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th><th onclick="sortTable('goodEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th><th onclick="sortTable('goodEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th><th onclick="sortTable('goodEfficiencyTable',9)" class="number">CPC</th><th onclick="sortTable('goodEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th><th onclick="sortTable('goodEfficiencyTable',11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th><th onclick="sortTable('goodEfficiencyTable',12)" class="number">ROAS</th></tr></thead><tbody id="goodEfficiencyBody"><tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody></table></div><h3 style="margin: 20px 0 10px; color: #333;">âŒ íš¨ìœ¨ BAD (í•„í„° ë¯¸ì¶©ì¡±)</h3><div class="table-wrapper"><table id="badEfficiencyTable"><thead><tr><th onclick="sortTable('badEfficiencyTable',0)">ìˆœìœ„</th><th onclick="sortTable('badEfficiencyTable',1)">ìº í˜ì¸ìœ í˜•</th><th onclick="sortTable('badEfficiencyTable',2)">ê²€ìƒ‰ì–´</th><th onclick="sortTable('badEfficiencyTable',3)">ìº í˜ì¸</th><th onclick="sortTable('badEfficiencyTable',4)">ê´‘ê³ ê·¸ë£¹</th><th onclick="sortTable('badEfficiencyTable',5)" class="number">ê´‘ê³ ë¹„</th><th onclick="sortTable('badEfficiencyTable',6)" class="number">ë…¸ì¶œìˆ˜</th><th onclick="sortTable('badEfficiencyTable',7)" class="number">í´ë¦­ìˆ˜</th><th onclick="sortTable('badEfficiencyTable',8)" class="number">í´ë¦­ìœ¨</th><th onclick="sortTable('badEfficiencyTable',9)" class="number">CPC</th><th onclick="sortTable('badEfficiencyTable',10)" class="number">ì „í™˜ìˆ˜</th><th onclick="sortTable('badEfficiencyTable',11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th><th onclick="sortTable('badEfficiencyTable',12)" class="number">ROAS</th></tr></thead><tbody id="badEfficiencyBody"><tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody></table></div></div></div>

  <!-- TAB 8: CPC (layout kept but filters must match efficiency via JS; placeholder container) -->
  <div id="cpc" class="tab-content"><div class="section" id="section-cpc"><div class="section-title"><span>ğŸ’² CPC ë¶„ì„</span></div><div class="info-box">ğŸ’¡ í•„í„°ë§ì„ íš¨ìœ¨ë¶„ì„ê³¼ ë™ì¼í•˜ê²Œ ì ìš©í•©ë‹ˆë‹¤.</div><div class="controls" id="cpcControls"><input class="text-col" type="text" id="cpcBrandExclude" placeholder="ì œì™¸ í‚¤ì›Œë“œ(ì½¤ë§ˆ)"><select id="cpcCampaignTypeFilter"><option value="">ìº í˜ì¸ ìœ í˜• ì „ì²´</option></select><select id="cpcCampaignFilter"><option value="">ìº í˜ì¸ ì „ì²´</option></select><select id="cpcAdgroupFilter"><option value="">ê´‘ê³ ê·¸ë£¹ ì „ì²´</option></select><input type="number" id="cpcFilterCostMin" placeholder="ìµœì†Œ ê´‘ê³ ë¹„"><input type="number" id="cpcFilterConvMin" placeholder="ìµœì†Œ ì „í™˜ìˆ˜"><input type="number" id="cpcFilterROASMin" placeholder="ìµœì†Œ ROAS"><input type="number" id="cpcFilterCPAMin" placeholder="ìµœì†Œ ì „í™˜ë‹¹ë¹„ìš©"><button onclick="updateCPCAnalysis()">ğŸ” ì ìš©</button><button class="danger" onclick="resetCPC()">ì´ˆê¸°í™”</button><button class="secondary" onclick="toggleChangeBadge('cpcTable')">ì¦ê°ìœ¨ On/Off</button></div><div class="table-wrapper"><table id="cpcTable"><thead><tr><th onclick="sortTable('cpcTable',0)">ìˆœìœ„</th><th onclick="sortTable('cpcTable',1)">ìº í˜ì¸ìœ í˜•</th><th onclick="sortTable('cpcTable',2)">ê²€ìƒ‰ì–´</th><th onclick="sortTable('cpcTable',3)">ìº í˜ì¸</th><th onclick="sortTable('cpcTable',4)">ê´‘ê³ ê·¸ë£¹</th><th onclick="sortTable('cpcTable',5)" class="number">ê´‘ê³ ë¹„</th><th onclick="sortTable('cpcTable',6)" class="number">ë…¸ì¶œìˆ˜</th><th onclick="sortTable('cpcTable',7)" class="number">í´ë¦­ìˆ˜</th><th onclick="sortTable('cpcTable',8)" class="number">í´ë¦­ìœ¨</th><th onclick="sortTable('cpcTable',9)" class="number">CPC</th><th onclick="sortTable('cpcTable',10)" class="number">ì „í™˜ìˆ˜</th><th onclick="sortTable('cpcTable',11)" class="number">ì „í™˜ë‹¹ë¹„ìš©</th><th onclick="sortTable('cpcTable',12)" class="number">ROAS</th></tr></thead><tbody id="cpcBody"><tr><td colspan="13" class="no-data">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody></table></div></div></div>

  <!-- TAB 9: Device (placeholder; original script must handle) -->
  <div id="device" class="tab-content"><div class="section"><div class="section-title"><span>ğŸ“± ë””ë°”ì´ìŠ¤ ë¶„ì„</span></div><div class="info-box">(ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)</div></div></div>

  <!-- TAB: ì‡¼í•‘-ìƒí’ˆ ë¶„ì„ (new) -->
  <div id="shopProduct" class="tab-content">
    <div class="section" id="section-shopProduct">
      <div class="section-title"><span>ğŸ›ï¸ ì‡¼í•‘-ìƒí’ˆ ë¶„ì„ (ìµœê·¼ 7ì¼ vs ì§€ë‚œì£¼)</span></div>

      <div class="shop-upload" id="shopUploadSection">
        <div class="file-input-group"><label>1. ìƒí’ˆ ì •ë³´ (TSV)</label><input type="file" id="shopTsvFile" accept=".tsv" /></div>
        <div class="file-input-group"><label>2. ì„±ê³¼ ë³´ê³ ì„œ (CSV)</label><input type="file" id="shopCsvFile" accept=".csv" /></div>
        <button class="controls" style="margin:0;"><button onclick="startShopAnalysis()" style="background:#007bff; color:white; border:none; padding:10px 25px; border-radius:6px; cursor:pointer; font-weight:bold;">ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button></button>
      </div>

      <div id="shopResultArea" style="display:none;">
        <div id="shopCpCards" class="shop-filter-section"></div>
        <div id="shopGrCards" class="shop-filter-section"></div>

        <div class="shop-table-wrapper">
          <table class="shop-table">
            <thead>
              <tr>
                <th>ì´ë¯¸ì§€</th>
                <th onclick="shopResort('cp')" class="shop-col-campaign">ìº í˜ì¸</th>
                <th onclick="shopResort('gr')" class="shop-col-adgroup">ê´‘ê³ ê·¸ë£¹</th>
                <th class="shop-col-product">ìƒí’ˆëª…</th>
                <th onclick="shopResort('cost')">ê´‘ê³ ë¹„</th>
                <th onclick="shopResort('view')">ë…¸ì¶œìˆ˜</th>
                <th onclick="shopResort('click')">í´ë¦­ìˆ˜</th>
                <th onclick="shopResort('ctr')">í´ë¦­ìœ¨</th>
                <th onclick="shopResort('cpc')">CPC</th>
                <th onclick="shopResort('cv')">ì „í™˜ìˆ˜</th>
                <th onclick="shopResort('amt')">ë§¤ì¶œì•¡</th>
                <th onclick="shopResort('roas')">ROAS</th>
              </tr>
            </thead>
            <tbody id="shopTableBody"></tbody>
          </table>
        </div>

        <div id="shopDetailSection" class="shop-detail">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="shopDetailTitle" style="margin:0;"></h3>
            <button onclick="document.getElementById('shopDetailSection').style.display='none'" style="color:#dc3545; border:none; background:none; cursor:pointer; font-weight:bold; font-size: 16px;">[âœ•]</button>
          </div>
          <div class="shop-tab-area" id="shopTabArea"></div>
          <div class="shop-chart-grid">
            <div class="shop-chart-container">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h5 style="margin:0;">ğŸ“… ì¼ë³„ ì¶”ì´</h5></div>
              <div id="shopDayStats" class="shop-stats-row"></div>
              <div class="shop-chart-box"><canvas id="shopDayChart"></canvas></div>
            </div>
            <div class="shop-chart-container">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h5 style="margin:0;">ğŸ“Š ì£¼ë³„ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h5></div>
              <div id="shopWeekStats" class="shop-stats-row"></div>
              <div class="shop-chart-box"><canvas id="shopWeekChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>

      <div class="info-box" style="margin-top: 14px;">
        ğŸ’¡ ì´ í˜ì´ì§€ëŠ” ì†Œì¬.htmlì˜ í™”ë©´/ê¸°ëŠ¥ì„ ê·¸ëŒ€ë¡œ í¬í•¨í•©ë‹ˆë‹¤. (ë‹¤ë§Œ ì¦ê°ìœ¨/ìƒ‰/í°íŠ¸ëŠ” ê¸°ì¡´ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ë¡œ í†µì¼)
      </div>
    </div>
  </div>
</div>

<script>
  /*********************************************************************
   * NOTE
   * - The original marketing_report JS is very large. This patch keeps
   *   existing function names referenced by the UI.
   * - We only ADD new functions / wrappers and minimally adjust behavior
   *   requested by the user.
   *********************************************************************/

  // === Global data holders (existing script uses these names in many places) ===
  let rawData = [];   // from RAW
  let raw2Data = [];  // from RAW2

  // NEW: ì‡¼í•‘ ë°ì´í„° holders
  let shopRaw = [], shopPMap = {}, shopAggList = [];
  let shopDChart = null, shopWChart = null;
  let shopMetric = 'amt';
  let shopSKey = 'cv', shopSDir = 'desc', shopActiveMat = null;
  let shopFilterCp = null, shopFilterGr = null;

  // Keep plugin usage
  if (window.Chart && window.ChartDataLabels) {
    try { Chart.register(ChartDataLabels); } catch(e) {}
  }

  const shopMetricNames = {
    amt: 'ë§¤ì¶œì•¡',
    cost: 'ê´‘ê³ ë¹„',
    view: 'ë…¸ì¶œìˆ˜',
    click: 'í´ë¦­ìˆ˜',
    cv: 'ì „í™˜ìˆ˜',
    ctr: 'í´ë¦­ìœ¨(%)',
    cvr: 'ì „í™˜ìœ¨(%)',
    roas: 'ROAS(%)',
    cpc: 'CPC'
  };

  // === Drag & drop helpers ===
  function setupDropzone(zoneId, inputId, doneClassTargetId) {
    const dz = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    if (!dz || !input) return;

    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover','dragleave','drop'].forEach(evt => dz.addEventListener(evt, prevent));
    dz.addEventListener('dragenter', () => dz.classList.add('dragover'));
    dz.addEventListener('dragover', () => dz.classList.add('dragover'));
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', (e) => {
      dz.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files && files.length) {
        input.files = files;
        input.dispatchEvent(new Event('change'));
      }
    });

    input.addEventListener('change', () => {
      const has = input.files && input.files.length;
      if (has) dz.classList.add('done'); else dz.classList.remove('done');
    });
  }

  // Initialize dropzones
  document.addEventListener('DOMContentLoaded', () => {
    setupDropzone('dzRaw', 'fileInputRaw');
    setupDropzone('dzRaw2', 'fileInputRaw2');
    setupDropzone('dzShopCsv', 'fileInputShopCsv');
    setupDropzone('dzShopTsv', 'fileInputShopTsv');
  });

  // === Upload handler wrapper ===
  // Existing file had handleUpload(event, type). We keep name and extend.
  async function handleUpload(event, type) {
    const file = event?.target?.files?.[0];
    if (!file) return;

    // Mark status
    const status = document.getElementById('uploadStatus');
    if (status) {
      status.style.display = 'block';
      status.className = 'status';
      status.textContent = `ì—…ë¡œë“œ ì¤‘: ${file.name}`;
    }

    try {
      if (type === 'raw' || type === 'raw2') {
        const data = await readCsvOrXlsx(file);
        if (type === 'raw') rawData = data;
        if (type === 'raw2') raw2Data = data;

        // Update check UI
        if (type === 'raw') document.getElementById('dzRaw')?.classList.add('done');
        if (type === 'raw2') document.getElementById('dzRaw2')?.classList.add('done');

        // Recompute all existing dashboards if original functions exist
        safeRebuildAll();
      }

      if (type === 'shopCsv') {
        // keep as File for papa parse (EUC-KR)
        window.__shopCsvFile = file;
        document.getElementById('dzShopCsv')?.classList.add('done');
      }
      if (type === 'shopTsv') {
        window.__shopTsvFile = file;
        document.getElementById('dzShopTsv')?.classList.add('done');
      }

      if (status) {
        status.className = 'status success';
        status.textContent = `ì—…ë¡œë“œ ì™„ë£Œ: ${file.name}`;
      }
    } catch (e) {
      console.error(e);
      if (status) {
        status.className = 'status error';
        status.textContent = `ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name}`;
      }
    }
  }

  // === Minimal readers ===
  async function readCsvOrXlsx(file) {
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    const buf = await file.arrayBuffer();

    if (ext === 'csv') {
      // Try UTF-8 first; if BOM or weird, browser typically handles.
      const text = new TextDecoder('utf-8').decode(buf);
      return parseCsvText(text);
    }

    // xlsx/xls
    const wb = XLSX.read(buf, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
    return json;
  }

  function parseCsvText(text) {
    // Split respecting simple CSV; we fallback to Papa if available.
    if (window.Papa) {
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      return parsed.data;
    }
    return text.split(/\r?\n/).filter(Boolean).map(line => line.split(','));
  }

  // === Tab switching (existing) ===
  function switchTab(evt, tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    evt.currentTarget.classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }

  // === Safety wrapper: keep existing report functions if present ===
  function safeRebuildAll() {
    // If original script defined these, call them.
    try { if (typeof buildFilters === 'function') buildFilters(); } catch(e) {}
    try { if (typeof updateOverview === 'function') updateOverview(); } catch(e) {}
    try { if (typeof updateCampaignTable === 'function') updateCampaignTable(); } catch(e) {}
    try { if (typeof updateAdgroupTable === 'function') updateAdgroupTable(); } catch(e) {}
    try { if (typeof updateKeywordTable === 'function') updateKeywordTable(true); } catch(e) {}
    try { if (typeof updateMediaTable === 'function') updateMediaTable(); } catch(e) {}
    try { if (typeof updateEfficiencyAnalysis === 'function') updateEfficiencyAnalysis(); } catch(e) {}
    try { if (typeof updateCPCAnalysis === 'function') updateCPCAnalysis(); } catch(e) {}
    try { if (typeof updateRankHeatmap === 'function') updateRankHeatmap(); } catch(e) {}
    try { if (typeof updateRankTrend === 'function') updateRankTrend(); } catch(e) {}

    // NEW rank top10 cards
    try { renderRankTop10Sticky(); } catch(e) {}
  }

  // === Rank TOP10 sticky tables (based on RAW2 keyword data) ===
  function renderRankTop10Sticky() {
    const grid = document.getElementById('rankTop10Grid');
    if (!grid) return;

    // Use RAW2 keyword data; if not present, show placeholder.
    if (!raw2Data || raw2Data.length < 2) {
      grid.innerHTML = '<div class="info-box" style="grid-column: 1 / -1;">RAW2 ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê²€ìƒ‰ì–´ TOP10 í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
      return;
    }

    // Find header index
    const headerIdx = raw2Data.findIndex(r => (r || []).join(',').includes('ìº í˜ì¸ìœ í˜•'));
    const rows = raw2Data.slice(headerIdx + 1).filter(r => r && r.length > 10);

    // Guess indices by header row
    const header = raw2Data[headerIdx] || [];
    const idx = {
      keyword: header.indexOf('ê²€ìƒ‰ì–´'),
      cost: header.indexOf('ì´ë¹„ìš©(VATí¬í•¨,ì›)'),
      view: header.indexOf('ë…¸ì¶œìˆ˜'),
      click: header.indexOf('í´ë¦­ìˆ˜'),
      cv: header.indexOf('ì „í™˜ìˆ˜'),
      amt: header.indexOf('ì „í™˜ë§¤ì¶œì•¡(ì›)')
    };

    const metrics = [
      { key: 'cost', label: 'ê´‘ê³ ë¹„ TOP10', fmt: v => Number(v||0).toLocaleString() },
      { key: 'view', label: 'ë…¸ì¶œìˆ˜ TOP10', fmt: v => Number(v||0).toLocaleString() },
      { key: 'click', label: 'í´ë¦­ìˆ˜ TOP10', fmt: v => Number(v||0).toLocaleString() },
      { key: 'cv', label: 'ì „í™˜ìˆ˜ TOP10', fmt: v => Number(v||0).toLocaleString() },
      { key: 'amt', label: 'ë§¤ì¶œì•¡ TOP10', fmt: v => Number(v||0).toLocaleString() }
    ];

    const aggByKeyword = new Map();
    rows.forEach(r => {
      const k = (r[idx.keyword] || '').toString().trim();
      if (!k) return;
      const o = aggByKeyword.get(k) || { cost:0, view:0, click:0, cv:0, amt:0 };
      o.cost += Number(r[idx.cost] || 0);
      o.view += Number(r[idx.view] || 0);
      o.click += Number(r[idx.click] || 0);
      o.cv += Number(r[idx.cv] || 0);
      o.amt += Number(r[idx.amt] || 0);
      aggByKeyword.set(k, o);
    });

    const entries = [...aggByKeyword.entries()].map(([keyword, v]) => ({ keyword, ...v }));

    grid.innerHTML = metrics.map(m => {
      const top = [...entries].sort((a,b) => (b[m.key]||0) - (a[m.key]||0)).slice(0,10);
      const rowsHtml = top.map((t, i) => `
        <tr>
          <td style="width:22px;">${i+1}</td>
          <td title="${escapeHtml(t.keyword)}" style="max-width:160px; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(t.keyword)}</td>
          <td style="text-align:right;">${m.fmt(t[m.key])}</td>
        </tr>
      `).join('');

      return `
        <div class="rank-mini-table">
          <div class="rank-mini-title">${m.label}</div>
          <table>
            <thead><tr><th>#</th><th>ê²€ìƒ‰ì–´</th><th style="text-align:right;">ê°’</th></tr></thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
      `;
    }).join('');
  }

  function escapeHtml(s){
    return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // === CPC analysis stubs (to avoid breaking if original existed elsewhere) ===
  function updateCPCAnalysis() {
    // If original exists, prefer it
    if (typeof window.__origUpdateCPCAnalysis === 'function') return window.__origUpdateCPCAnalysis();
    // Otherwise no-op
  }
  function resetCPC() {
    if (typeof window.__origResetCPC === 'function') return window.__origResetCPC();
    document.getElementById('cpcBrandExclude').value = '';
    document.getElementById('cpcFilterCostMin').value = '';
    document.getElementById('cpcFilterConvMin').value = '';
    document.getElementById('cpcFilterROASMin').value = '';
    document.getElementById('cpcFilterCPAMin').value = '';
    safeRebuildAll();
  }

  /*********************************************************************
   * ì‡¼í•‘-ìƒí’ˆ ë¶„ì„ (ported from ì†Œì¬.html)
   *********************************************************************/
  function startShopAnalysis() {
    const tsv = document.getElementById('shopTsvFile').files[0] || window.__shopTsvFile;
    const csv = document.getElementById('shopCsvFile').files[0] || window.__shopCsvFile;
    if (!tsv || !csv) return alert('íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');

    shopPMap = {};
    Papa.parse(tsv, {
      delimiter: '\t',
      skipEmptyLines: true,
      complete: (t) => {
        t.data.forEach(r => {
          if (r[2]) shopPMap[r[2].trim()] = { name: r[14], img: r[15] };
        });

        Papa.parse(csv, {
          encoding: 'EUC-KR',
          skipEmptyLines: true,
          complete: (c) => {
            const headRow = c.data.findIndex(r => (r || []).join(',').includes('ìº í˜ì¸ìœ í˜•'));
            shopRaw = c.data.slice(headRow + 1)
              .filter(r => r && r[0] === 'ì‡¼í•‘ê²€ìƒ‰')
              .map(r => ({
                cp: r[1],
                gr: r[2],
                mat: (r[3] || '').toString().trim(),
                date: r[6],
                week: r[7],
                cost: Number(r[8] || 0),
                view: Number(r[9] || 0),
                click: Number(r[10] || 0),
                cv: Number(r[11] || 0),
                amt: Number(r[12] || 0)
              }));

            document.getElementById('shopUploadSection').style.display = 'none';
            document.getElementById('shopResultArea').style.display = 'block';
            shopResetFilters();
          }
        });
      }
    });
  }

  function shopResetFilters() {
    shopFilterCp = null;
    shopFilterGr = null;
    shopRenderFilters();
    shopRefresh();
  }
  function shopSetCP(c){ shopFilterCp = c; shopFilterGr = null; shopRenderFilters(); shopRefresh(); }
  function shopSetGR(g){ shopFilterGr = g; shopRenderFilters(); shopRefresh(); }

  function shopRenderFilters() {
    const cps = [...new Set(shopRaw.map(d => d.cp))];
    let h = `<button class="shop-reset-btn" onclick="shopResetFilters()">ğŸ”„ ì´ˆê¸°í™”</button>`;
    h += `<div class="shop-card ${!shopFilterCp ? 'active' : ''}" onclick="shopSetCP(null)">ì „ì²´ ìº í˜ì¸</div>`;
    cps.forEach(c => h += `<div class="shop-card ${shopFilterCp === c ? 'active' : ''}" onclick="shopSetCP('${escapeHtml(c)}')">${escapeHtml(c)}</div>`);
    document.getElementById('shopCpCards').innerHTML = h;

    if (shopFilterCp) {
      const grs = [...new Set(shopRaw.filter(d => d.cp === shopFilterCp).map(d => d.gr))];
      let gh = `<div class="shop-card ${!shopFilterGr ? 'active' : ''}" onclick="shopSetGR(null)">ì „ì²´ ê´‘ê³ ê·¸ë£¹</div>`;
      grs.forEach(g => gh += `<div class="shop-card ${shopFilterGr === g ? 'active' : ''}" onclick="shopSetGR('${escapeHtml(g)}')">${escapeHtml(g)}</div>`);
      document.getElementById('shopGrCards').innerHTML = gh;
    } else {
      document.getElementById('shopGrCards').innerHTML = '';
    }
  }

  function shopRefresh() {
    const allDates = [...new Set(shopRaw.map(d => d.date))].sort().reverse();
    const curDates = allDates.slice(0, 7);
    const preDates = allDates.slice(7, 14);

    const filtered = shopRaw.filter(d => (!shopFilterCp || d.cp === shopFilterCp) && (!shopFilterGr || d.gr === shopFilterGr));

    const agg = {};
    const gCheck = {};
    filtered.forEach(r => {
      const pName = shopPMap[r.mat]?.name || 'ì•Œìˆ˜ì—†ìŒ';
      const gk = `${r.cp}_${r.gr}_${pName}`;
      if (!gCheck[gk]) gCheck[gk] = new Set();
      gCheck[gk].add(r.mat);

      if (!agg[r.mat]) {
        agg[r.mat] = { cp: r.cp, gr: r.gr, mat: r.mat, cost:0, view:0, click:0, cv:0, amt:0, pCost:0, pView:0, pClick:0, pCv:0, pAmt:0 };
      }

      if (curDates.includes(r.date)) {
        agg[r.mat].cost += r.cost;
        agg[r.mat].view += r.view;
        agg[r.mat].click += r.click;
        agg[r.mat].cv += r.cv;
        agg[r.mat].amt += r.amt;
      }
      if (preDates.includes(r.date)) {
        agg[r.mat].pCost += r.cost;
        agg[r.mat].pView += r.view;
        agg[r.mat].pClick += r.click;
        agg[r.mat].pCv += r.cv;
        agg[r.mat].pAmt += r.amt;
      }
    });

    shopAggList = Object.values(agg).map(r => {
      const pName = shopPMap[r.mat]?.name || 'ë§¤ì¹­ì‹¤íŒ¨';
      return {
        ...r,
        pName,
        pImg: shopPMap[r.mat]?.img || '',
        isG: (gCheck[`${r.cp}_${r.gr}_${pName}`]?.size || 0) > 1,
        ctr: r.view > 0 ? (r.click / r.view * 100) : 0,
        cpc: r.click > 0 ? (r.cost / r.click) : 0,
        roas: r.cost > 0 ? (r.amt / r.cost * 100) : 0,
        pCtr: r.pView > 0 ? (r.pClick / r.pView * 100) : 0,
        pCpc: r.pClick > 0 ? (r.pCost / r.pClick) : 0,
        pRoas: r.pCost > 0 ? (r.pAmt / r.pCost * 100) : 0
      };
    });

    shopAggList.sort((a,b) => {
      const va = a[shopSKey], vb = b[shopSKey];
      return shopSDir === 'desc' ? (vb - va) : (va - vb);
    });

    const getDiffPct = (cur, pre) => {
      if (!pre) return '';
      const d = ((cur - pre) / pre * 100);
      if (Math.abs(d) < 0.5) return '';
      const signUp = d > 0;
      const cls = signUp ? 'shop-up' : 'shop-down';
      const icon = signUp ? 'â–²' : 'â–¼';
      return `<span class="shop-diff ${cls}">(${icon}${Math.abs(d).toFixed(0)}%)</span>`;
    };

    document.getElementById('shopTableBody').innerHTML = shopAggList.map(r => `
      <tr onclick="shopViewDetail('${escapeHtml(r.mat)}')" style="cursor:pointer;">
        <td><img src="${escapeHtml(r.pImg)}" class="img-thumb" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2246%22 height=%2246%22%3E%3Crect fill=%22%23ddd%22 width=%2246%22 height=%2246%22/%3E%3C/svg%3E'" /></td>
        <td class="shop-col-campaign" title="${escapeHtml(r.cp)}">${escapeHtml(r.cp)}</td>
        <td class="shop-col-adgroup" title="${escapeHtml(r.gr)}">${escapeHtml(r.gr)}</td>
        <td class="shop-col-product" title="${escapeHtml(r.pName)}"><b>${escapeHtml(r.pName)}</b>${r.isG ? '<span class="badge-group">ê·¸ë£¹</span>' : ''}</td>
        <td class="number">${Math.round(r.cost).toLocaleString()}${getDiffPct(r.cost, r.pCost)}</td>
        <td class="number">${Math.round(r.view).toLocaleString()}${getDiffPct(r.view, r.pView)}</td>
        <td class="number">${Math.round(r.click).toLocaleString()}${getDiffPct(r.click, r.pClick)}</td>
        <td class="number">${r.ctr.toFixed(2)}%${getDiffPct(r.ctr, r.pCtr)}</td>
        <td class="number">${Math.round(r.cpc).toLocaleString()}${getDiffPct(r.cpc, r.pCpc)}</td>
        <td class="number">${Math.round(r.cv).toLocaleString()}${getDiffPct(r.cv, r.pCv)}</td>
        <td class="number"><b>${Math.round(r.amt).toLocaleString()}</b>${getDiffPct(r.amt, r.pAmt)}</td>
        <td class="number"><b>${r.roas.toFixed(0)}%</b>${getDiffPct(r.roas, r.pRoas)}</td>
      </tr>
    `).join('');
  }

  function shopResort(k) {
    shopSKey = k;
    shopSDir = (shopSDir === 'desc') ? 'asc' : 'desc';
    shopRefresh();
  }

  function shopViewDetail(mat) {
    shopActiveMat = mat;
    document.getElementById('shopDetailSection').style.display = 'block';
    document.getElementById('shopDetailTitle').innerText = `[ì „ì²´ ê¸°ê°„] ${(shopPMap[mat]?.name) || mat}`;

    let th = '';
    for (let k in shopMetricNames) {
      th += `<button class="shop-tab-btn ${shopMetric === k ? 'active' : ''}" onclick="shopSetMetric('${k}')">${shopMetricNames[k]}</button>`;
    }
    document.getElementById('shopTabArea').innerHTML = th;

    shopDrawCharts();
    setTimeout(() => document.getElementById('shopDetailSection').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  }

  function shopSetMetric(m){ shopMetric = m; shopDrawCharts(); }

  function shopDrawCharts() {
    const filteredData = shopRaw.filter(d => d.mat === shopActiveMat);

    const dayMap = {};
    filteredData.forEach(d => {
      if (!dayMap[d.date]) dayMap[d.date] = { date: d.date, cost:0, view:0, click:0, cv:0, amt:0 };
      dayMap[d.date].cost += d.cost;
      dayMap[d.date].view += d.view;
      dayMap[d.date].click += d.click;
      dayMap[d.date].cv += d.cv;
      dayMap[d.date].amt += d.amt;
    });
    const dData = Object.values(dayMap).sort((a,b) => a.date.localeCompare(b.date));

    const wMap = {};
    filteredData.forEach(d => {
      if (!wMap[d.week]) wMap[d.week] = { cost:0, view:0, click:0, cv:0, amt:0 };
      wMap[d.week].cost += d.cost;
      wMap[d.week].view += d.view;
      wMap[d.week].click += d.click;
      wMap[d.week].cv += d.cv;
      wMap[d.week].amt += d.amt;
    });

    const getValue = (o) => {
      if (shopMetric === 'ctr') return o.view > 0 ? (o.click / o.view * 100) : 0;
      if (shopMetric === 'cvr') return o.click > 0 ? (o.cv / o.click * 100) : 0;
      if (shopMetric === 'roas') return o.cost > 0 ? (o.amt / o.cost * 100) : 0;
      if (shopMetric === 'cpc') return o.click > 0 ? (o.cost / o.click) : 0;
      return o[shopMetric] || 0;
    };

    const formatValue = (val) => {
      if (['ctr','cvr','roas'].includes(shopMetric)) return val.toFixed(1) + '%';
      return Math.round(val).toLocaleString();
    };

    const renderStats = (id, values, prefix) => {
      if (!values.length) { document.getElementById(id).innerHTML = ''; return; }
      const max = Math.max(...values);
      const min = Math.min(...values);
      const avg = values.reduce((a,b)=>a+b,0) / values.length;
      document.getElementById(id).innerHTML = `
        <div class="shop-stat-item"><div class="shop-stat-label">${prefix} ìµœê³ </div><div class="shop-stat-value max">${formatValue(max)}</div></div>
        <div class="shop-stat-item"><div class="shop-stat-label">${prefix} ìµœì €</div><div class="shop-stat-value min">${formatValue(min)}</div></div>
        <div class="shop-stat-item"><div class="shop-stat-label">${prefix} í‰ê· </div><div class="shop-stat-value">${formatValue(avg)}</div></div>
      `;
    };

    // Day chart
    if (shopDChart) shopDChart.destroy();
    const dayLabels = dData.map(d => d.date);
    const dayValues = dData.map(d => getValue(d));
    renderStats('shopDayStats', dayValues, 'ì¼');

    shopDChart = new Chart(document.getElementById('shopDayChart'), {
      type: 'line',
      data: { labels: dayLabels, datasets: [{
        label: shopMetricNames[shopMetric],
        data: dayValues,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.10)',
        tension: 0.4,
        fill: true,
        pointRadius: 5,
        pointHoverRadius: 8,
        pointBackgroundColor: '#007bff',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        borderWidth: 3
      }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          datalabels: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            titleFont: { size: 13 },
            bodyFont: { size: 14, weight: 'bold' },
            callbacks: { label: (ctx) => shopMetricNames[shopMetric] + ': ' + formatValue(ctx.parsed.y) }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { callback: (v) => formatValue(v) }, grid: { color: '#f0f0f0' } },
          x: { grid: { display: false } }
        }
      }
    });

    // Week chart (last 4)
    const weekKeys = Object.keys(wMap).sort().slice(-4);
    const weekValues = weekKeys.map(k => getValue(wMap[k]));
    renderStats('shopWeekStats', weekValues, 'ì£¼');

    const weekColors = weekKeys.map((k, idx) => idx === weekKeys.length - 1 ? '#5DADE2' : '#D6EAF8');

    if (shopWChart) shopWChart.destroy();
    shopWChart = new Chart(document.getElementById('shopWeekChart'), {
      type: 'bar',
      data: { labels: weekKeys, datasets: [{
        label: shopMetricNames[shopMetric],
        data: weekValues,
        backgroundColor: weekColors,
        borderColor: '#fff',
        borderWidth: 2,
        datalabels: {
          anchor: 'center',
          align: 'center',
          color: '#2c3e50',
          font: { weight: 'bold', size: 13 },
          formatter: (v) => formatValue(v)
        }
      }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            titleFont: { size: 13 },
            bodyFont: { size: 14, weight: 'bold' },
            callbacks: { label: (ctx) => shopMetricNames[shopMetric] + ': ' + formatValue(ctx.parsed.y) }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { callback: (v) => formatValue(v) }, grid: { color: '#f0f0f0' } },
          x: { grid: { display: false } }
        }
      }
    });
  }
</script>
</body>
</html>
